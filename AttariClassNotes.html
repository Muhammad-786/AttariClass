<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari — Class Notes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">Attari — Class Notes</h1>
        <p class="text-slate-500 dark:text-slate-400">Daily notes database powered by Firebase (Firestore + Anonymous Auth).</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="authStatus" class="px-3 py-1 rounded-full text-sm bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">Connecting…</span>
        <button id="exportCsvBtn" class="hidden md:inline-flex px-4 py-2 rounded-xl shadow-sm bg-white dark:bg-slate-900 ring-1 ring-slate-200 dark:ring-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition">Export CSV</button>
      </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <!-- Left: Today Form -->
      <section class="lg:col-span-2">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm ring-1 ring-slate-200 dark:ring-slate-800">
          <div class="p-5 md:p-6 border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold">Today’s Entry</h2>
              <div class="text-sm text-slate-500 dark:text-slate-400">Date (auto): <span id="todayDisplay" class="font-medium"></span></div>
            </div>
          </div>
          <form id="notesForm" class="p-5 md:p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Quran</label>
                <input id="quran" type="text" class="w-full rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" placeholder="e.g., Juz 1, pages 1–10" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Surah</label>
                <input id="surah" type="text" class="w-full rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" placeholder="e.g., Al-Fātiḥah 1–7" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Laws of Salah</label>
                <input id="laws" type="text" class="w-full rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" placeholder="e.g., Wudu requirements" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Qamar</label>
                <input id="qamar" type="text" class="w-full rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" placeholder="e.g., Lesson / notes" />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Anything else</label>
              <textarea id="anything" rows="4" class="w-full rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" placeholder="Free-form notes, reminders, homework, etc."></textarea>
            </div>
            <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3">
              <button type="submit" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-medium shadow hover:bg-emerald-700 transition">Save / Update today</button>
              <button id="clearFormBtn" type="button" class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700 transition">Clear form</button>
              <span id="saveStatus" class="text-sm text-slate-500"></span>
            </div>
          </form>
        </div>
      </section>

      <!-- Right: Students -->
      <aside class="lg:col-span-1">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm ring-1 ring-slate-200 dark:ring-slate-800 overflow-hidden">
          <div class="p-5 md:p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Students</h2>
            <button id="syncStudentsBtn" class="text-sm px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700">Sync to Firestore</button>
          </div>
          <ul id="studentsList" class="p-5 md:p-6 grid grid-cols-1 gap-2 text-sm"></ul>
        </div>
      </aside>
    </div>

    <!-- History -->
    <section class="mt-8">
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm ring-1 ring-slate-200 dark:ring-slate-800">
        <div class="p-5 md:p-6 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
          <div>
            <h2 class="text-xl font-semibold">History</h2>
            <p class="text-sm text-slate-500">Browse previous days’ notes.</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <input id="filterInput" type="text" placeholder="Filter (e.g., Surah, keyword)" class="flex-1 sm:w-64 rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2" />
            <select id="limitSelect" class="rounded-xl bg-slate-50 dark:bg-slate-950/50 border border-slate-200 dark:border-slate-800 px-3 py-2">
              <option value="7">Last 7</option>
              <option value="14">Last 14</option>
              <option value="30" selected>Last 30</option>
              <option value="90">Last 90</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-slate-50 dark:bg-slate-950/50">
              <tr>
                <th class="px-4 py-3 font-medium">Date</th>
                <th class="px-4 py-3 font-medium">Quran</th>
                <th class="px-4 py-3 font-medium">Surah</th>
                <th class="px-4 py-3 font-medium">Laws of Salah</th>
                <th class="px-4 py-3 font-medium">Qamar</th>
                <th class="px-4 py-3 font-medium">Anything else</th>
              </tr>
            </thead>
            <tbody id="historyBody" class="divide-y divide-slate-100 dark:divide-slate-800">
              <!-- rows injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">
      Built for class <span class="font-semibold">Attari</span>. Data stored in your Firebase project <span class="font-mono">attari-579d2</span>.
    </footer>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase imports (v12 modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      getDocs,
      query,
      orderBy,
      limit as qLimit,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // --- CONFIG FROM YOUR PROJECT ---
    const firebaseConfig = {
      apiKey: "AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw",
      authDomain: "attari-579d2.firebaseapp.com",
      projectId: "attari-579d2",
      storageBucket: "attari-579d2.firebasestorage.app",
      messagingSenderId: "765966619098",
      appId: "1:765966619098:web:9ab852c4881426472b70e3"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const todayDisplay = document.getElementById('todayDisplay');
    const form = document.getElementById('notesForm');
    const inputs = {
      quran: document.getElementById('quran'),
      surah: document.getElementById('surah'),
      laws: document.getElementById('laws'),
      qamar: document.getElementById('qamar'),
      anything: document.getElementById('anything')
    };
    const saveStatus = document.getElementById('saveStatus');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const historyBody = document.getElementById('historyBody');
    const limitSelect = document.getElementById('limitSelect');
    const filterInput = document.getElementById('filterInput');
    const authStatus = document.getElementById('authStatus');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const studentsList = document.getElementById('studentsList');
    const syncStudentsBtn = document.getElementById('syncStudentsBtn');

    // Students — prefilled roster
    const students = [
      "Siyaam Azar",
      "Hussain Ali",
      "Hamza Razzaq",
      "Subhan Hussain",
      "Milad Raza",
      "Murtaza Arfan",
      "Zeeshan Hussain",
      "Mohammed Subhan Ramzan",
      "Onees Usman",
      "Mohammed Hassan Hussain",
      "Ali Hussein"
    ];

    // Render students list
    function renderStudents() {
      studentsList.innerHTML = students.map((name, i) => `
        <li class="flex items-center justify-between px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-950/40 ring-1 ring-slate-200 dark:ring-slate-800">
          <span class="font-medium">${name}</span>
          <span class="text-xs text-slate-500">#${i+1}</span>
        </li>
      `).join('');
    }
    renderStudents();

    // Helpers
    const todayIso = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const asText = v => (v ?? '').toString();

    // Show today
    const today = todayIso();
    todayDisplay.textContent = today;

    // Firestore paths
    const CLASS_ID = 'Attari';
    const classDocRef = doc(db, 'classes', CLASS_ID);
    const daysColRef = collection(classDocRef, 'days');

    // Auth (anonymous)
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authStatus.textContent = 'Connected';
        authStatus.className = 'px-3 py-1 rounded-full text-sm bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300';
        // Load today's entry into the form (if exists)
        await loadTodayIntoForm();
        // Start history stream
        startHistoryStream(parseInt(limitSelect.value, 10));
      } else {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          authStatus.textContent = 'Auth error';
          console.error(e);
        }
      }
    });

    // If not signed in yet, kick off anon sign-in
    signInAnonymously(auth).catch(() => {});

    // Save/Update today
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      saveStatus.textContent = 'Saving…';
      const data = {
        date: today, // stored as string for natural key & ordering
        quran: asText(inputs.quran.value).trim(),
        surah: asText(inputs.surah.value).trim(),
        lawsOfSalah: asText(inputs.laws.value).trim(),
        qamar: asText(inputs.qamar.value).trim(),
        anythingElse: asText(inputs.anything.value).trim(),
        updatedAt: serverTimestamp(),
      };
      const docRef = doc(daysColRef, today);
      // Merge so repeated saves update fields
      await setDoc(docRef, { createdAt: serverTimestamp(), ...data }, { merge: true });
      saveStatus.textContent = 'Saved ✅';
      setTimeout(() => saveStatus.textContent = '', 1500);
    });

    clearFormBtn.addEventListener('click', () => {
      Object.values(inputs).forEach(i => i.value = '');
    });

    // Load today’s form if existing
    async function loadTodayIntoForm() {
      const docRef = doc(daysColRef, today);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const d = snap.data();
        inputs.quran.value = d.quran ?? '';
        inputs.surah.value = d.surah ?? '';
        inputs.laws.value = d.lawsOfSalah ?? '';
        inputs.qamar.value = d.qamar ?? '';
        inputs.anything.value = d.anythingElse ?? '';
      }
    }

    // History stream
    let unsubHistory = null;
    function startHistoryStream(n = 30) {
      if (unsubHistory) unsubHistory();
      const q = query(daysColRef, orderBy('date', 'desc'), qLimit(n));
      unsubHistory = onSnapshot(q, (snap) => {
        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          rows.push({
            date: d.date,
            quran: d.quran || '',
            surah: d.surah || '',
            lawsOfSalah: d.lawsOfSalah || '',
            qamar: d.qamar || '',
            anythingElse: d.anythingElse || ''
          });
        });
        renderHistory(rows);
      });
    }

    function renderHistory(rows) {
      const filter = filterInput.value.toLowerCase().trim();
      const filtered = !filter ? rows : rows.filter(r => Object.values(r).some(v => (v||'').toLowerCase().includes(filter)));
      historyBody.innerHTML = filtered.map(r => `
        <tr class="hover:bg-slate-50/60 dark:hover:bg-slate-900/40">
          <td class="px-4 py-3 font-medium">${r.date}</td>
          <td class="px-4 py-3">${escapeHtml(r.quran)}</td>
          <td class="px-4 py-3">${escapeHtml(r.surah)}</td>
          <td class="px-4 py-3">${escapeHtml(r.lawsOfSalah)}</td>
          <td class="px-4 py-3">${escapeHtml(r.qamar)}</td>
          <td class="px-4 py-3">${escapeHtml(r.anythingElse)}</td>
        </tr>
      `).join('');
    }

    filterInput.addEventListener('input', () => startHistoryStream(parseInt(limitSelect.value, 10)));
    limitSelect.addEventListener('change', () => startHistoryStream(parseInt(limitSelect.value, 10)));

    // Export CSV
    exportCsvBtn.addEventListener('click', async () => {
      const n = parseInt(limitSelect.value, 10);
      const qy = query(daysColRef, orderBy('date', 'desc'), qLimit(n));
      const snap = await getDocs(qy);
      const items = [];
      snap.forEach(doc => items.push(doc.data()));
      const csv = toCSV(items, ['date','quran','surah','lawsOfSalah','qamar','anythingElse']);
      downloadFile(csv, `attari-notes-last-${n}.csv`, 'text/csv');
    });

    // Sync students to Firestore (stored under classes/Attari students[])
    syncStudentsBtn.addEventListener('click', async () => {
      await setDoc(classDocRef, { name: CLASS_ID, students, updatedAt: serverTimestamp() }, { merge: true });
      syncStudentsBtn.textContent = 'Synced ✓';
      setTimeout(() => syncStudentsBtn.textContent = 'Sync to Firestore', 1500);
    });

    // Utils
    function escapeHtml(s) {
      return (s ?? '').replace(/[&<>"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }
    function toCSV(rows, headers) {
      const esc = (v) => {
        const s = (v ?? '').toString();
        return /[",\n]/.test(s) ? '"' + s.replaceAll('"','""') + '"' : s;
      };
      const head = headers.join(',');
      const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
      return head + '\n' + body + '\n';
    }
    function downloadFile(content, filename, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }
  </script>
</body>
</html>
