<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari — Class Tracker (Custom Columns)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{color-scheme:light dark;--grad-emerald:linear-gradient(135deg,#10b981 0%,#059669 100%)}
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .glass{backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .btn-primary{background:var(--grad-emerald);color:#fff;border-radius:1rem;padding:.9rem 1.25rem;font-weight:700}
    .spinner{width:18px;height:18px;border:2px solid rgba(16,185,129,.35);border-top:2px solid #10b981;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notification{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:600;z-index:50;transform:translateX(320px);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:linear-gradient(135deg,#10b981,#059669)}
    .notification.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen">
  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-emerald-600">Attari Class Tracker</h1>
      <p class="mt-3 text-slate-600 dark:text-slate-400">Custom columns • per‑student notes • edit/delete</p>
      <p class="mt-2 text-sm"><span id="authStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 dark:bg-slate-800/70 ring-1 ring-slate-200 dark:ring-slate-700"><span id="whoami">Not signed in</span> • <span id="todayDisplay"></span></span></p>
    </header>

    <!-- AUTH GATE -->
    <div id="authGate" class="max-w-xl mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
          <h2 class="text-2xl font-bold">Sign in</h2>
          <button id="showSignup" class="text-sm text-emerald-700 hover:underline">Create account</button>
        </div>
        <form id="signinForm" class="p-6 md:p-8 space-y-4">
          <input id="siEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="siPass" type="password" placeholder="Password" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full">Sign in</button>
          <p id="siMsg" class="text-sm text-slate-500"></p>
        </form>
        <form id="signupForm" class="hidden p-6 md:p-8 space-y-4">
          <div class="text-sm text-slate-500">Create your teacher account.</div>
          <input id="suEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3" required />
          <input id="suPass" type="password" placeholder="Password (min 6)" minlength="6" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3" required />
          <button class="btn-primary w-full">Create account</button>
          <p id="suMsg" class="text-sm text-slate-500"></p>
          <div class="text-sm"><button id="showSignin" type="button" class="text-emerald-700 hover:underline">Back to sign in</button></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
        <!-- Column Manager -->
        <section class="xl:col-span-2">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
              <h2 class="text-2xl font-bold">🧩 Columns</h2>
              <button id="signOutBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm">Sign out</button>
            </div>
            <div class="p-6 md:p-8 space-y-5">
              <p class="text-sm text-slate-600 dark:text-slate-400">Add, rename, delete, or reorder columns. These define the inputs for each note.</p>
              <div id="columnsList" class="space-y-2"></div>
              <div class="flex gap-2">
                <input id="newColLabel" type="text" placeholder="New column label (e.g., Quran)" class="flex-1 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-3 py-2" />
                <button id="addColBtn" class="btn-primary">Add</button>
              </div>
              <div class="text-xs text-slate-500">Default columns will be created on first load if none exist.</div>
            </div>
          </div>
        </section>

        <!-- Form + History -->
        <section class="xl:col-span-3 space-y-8">
          <!-- Form Card -->
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50">
              <h2 class="text-2xl font-bold"><span id="formTitle">✨ New Entry</span></h2>
            </div>
            <form id="notesForm" class="p-6 md:p-8 space-y-6">
              <div>
                <label class="block text-sm font-semibold mb-1">👤 Student</label>
                <select id="student" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3" required>
                  <option value="" disabled selected>Choose a student…</option>
                </select>
              </div>
              <div id="dynamicFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
              <div class="flex flex-col sm:flex-row gap-4">
                <button id="saveBtn" type="submit" class="btn-primary flex-1 inline-flex items-center justify-center gap-3"><span id="saveText">💾 Save Entry</span><div id="saveSpinner" class="spinner hidden"></div></button>
                <button id="cancelEditBtn" type="button" class="hidden px-6 py-3 rounded-2xl bg-slate-200/80 dark:bg-slate-700/80">✖️ Cancel Edit</button>
              </div>
              <div id="saveStatus" class="text-center text-sm font-medium"></div>
            </form>
          </div>

          <!-- History Card -->
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold">📊 Progress History</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Real‑time per‑student notes (latest first)</p>
              </div>
              <div class="flex flex-wrap gap-3">
                <select id="filterStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium">
                  <option value="">All students</option>
                </select>
                <input id="filterDate" type="date" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium" />
                <button id="clearFilters" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80">🔄 Clear</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-left text-sm">
                <thead id="tableHead" class="sticky top-0 backdrop-blur bg-slate-100/90 dark:bg-slate-800/90"></thead>
                <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
              </table>
              <div id="emptyState" class="hidden text-center py-12 text-slate-500">No entries yet</div>
            </div>
            <div class="p-6 flex items-center justify-between border-t border-slate-200/50 dark:border-slate-700/50">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <button id="reload" class="px-4 py-2 rounded-xl text-white font-medium shadow-lg bg-gradient-to-r from-blue-500 to-purple-500">🔄 Refresh</button>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-10 text-center text-xs text-slate-600 dark:text-slate-400">Data: <span class="font-mono">classes/Attari/notes</span> • Columns in <span class="font-mono">classes/Attari/config</span></footer>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, limit as qLimit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw", authDomain:"attari-579d2.firebaseapp.com", projectId:"attari-579d2", storageBucket:"attari-579d2.firebasestorage.app", messagingSenderId:"765966619098", appId:"1:765966619098:web:9ab852c4881426472b70e3" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const authGate=document.getElementById('authGate'); const appShell=document.getElementById('app'); const authStatus=document.getElementById('authStatus'); const whoami=document.getElementById('whoami'); const signOutBtn=document.getElementById('signOutBtn'); const toast=document.getElementById('toast');

    const signinForm=document.getElementById('signinForm'); const signupForm=document.getElementById('signupForm');
    document.getElementById('showSignup').addEventListener('click',()=>{signinForm.classList.add('hidden');signupForm.classList.remove('hidden')});
    document.getElementById('showSignin').addEventListener('click',()=>{signupForm.classList.add('hidden');signinForm.classList.remove('hidden')});
    signinForm.addEventListener('submit', async e=>{e.preventDefault(); try{await signInWithEmailAndPassword(auth, siEmail.value.trim(), siPass.value);}catch(err){siMsg.textContent=err.message; showToast(err.message,'error');}});
    signupForm.addEventListener('submit', async e=>{e.preventDefault(); try{await createUserWithEmailAndPassword(auth, suEmail.value.trim(), suPass.value); suMsg.textContent='Account created. Signed in.'; showToast('Welcome!','success');}catch(err){suMsg.textContent=err.message; showToast(err.message,'error');}});
    signOutBtn?.addEventListener('click',()=>signOut(auth));

    const students=["Siyaam Azar","Hussain Ali","Hamza Razzaq","Subhan Hussain","Milad Raza","Murtaza Arfan","Zeeshan Hussain","Mohammed Subhan Ramzan","Onees Usman","Mohammed Hassan Hussain","Ali Hussein"];
    const inputs={student:document.getElementById('student'), dynamicFields:document.getElementById('dynamicFields')};
    const filterStudent=document.getElementById('filterStudent'); const filterDate=document.getElementById('filterDate'); const tableHead=document.getElementById('tableHead'); const historyBody=document.getElementById('historyBody'); const emptyState=document.getElementById('emptyState'); const countInfo=document.getElementById('countInfo');

    const today = new Date().toISOString().slice(0,10); document.getElementById('todayDisplay').textContent=today;
    const CLASS_ID='Attari';
    const classDoc=doc(db,'classes',CLASS_ID);
    const notesCol=collection(classDoc,'notes');
    const configDoc=doc(classDoc,'config');

    // Columns state
    let columns=[]; // [{id,label}]

    // Initialize default columns if none
    async function ensureDefaultColumns(){
      const snap=await getDoc(configDoc);
      if (!snap.exists() || !Array.isArray(snap.data().columns) || !snap.data().columns.length){
        const def=[
          {id:'quran', label:'Quran'},
          {id:'surah', label:'Surah'},
          {id:'laws', label:'Laws of Salah'},
          {id:'qamar', label:'Qamar'},
          {id:'anything', label:'Anything else'}
        ];
        await setDoc(configDoc,{columns:def,updatedAt:serverTimestamp()},{merge:true});
        columns=def;
      } else {
        columns=[...snap.data().columns];
      }
      renderColumnsManager();
      renderDynamicInputs();
      renderTableHead();
    }

    // Populate students
    function populateStudents(){ inputs.student.innerHTML='<option value="" disabled selected>Choose a student…</option>'; filterStudent.innerHTML='<option value="">All students</option>'; students.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; inputs.student.appendChild(o); const o2=o.cloneNode(true); filterStudent.appendChild(o2); }); }
    populateStudents();

    // Columns Manager rendering
    const columnsList=document.getElementById('columnsList'); const newColLabel=document.getElementById('newColLabel'); const addColBtn=document.getElementById('addColBtn');
    function renderColumnsManager(){
      columnsList.innerHTML='';
      columns.forEach((c,idx)=>{
        const row=document.createElement('div');
        row.className='flex items-center gap-2';
        row.innerHTML=`
          <input data-id="${c.id}" value="${c.label}" class="flex-1 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-3 py-2" />
          <button data-act="up" data-idx="${idx}" class="px-2 py-1 rounded-lg ring-1 ring-slate-300">↑</button>
          <button data-act="down" data-idx="${idx}" class="px-2 py-1 rounded-lg ring-1 ring-slate-300">↓</button>
          <button data-act="del" data-id="${c.id}" class="px-2 py-1 rounded-lg ring-1 ring-red-300 text-red-700">Delete</button>`;
        columnsList.appendChild(row);
      });
    }

    columnsList.addEventListener('change', async (e)=>{
      const input=e.target.closest('input'); if(!input) return;
      const id=input.getAttribute('data-id'); const col=columns.find(x=>x.id===id); if(!col) return;
      col.label=input.value.trim()||col.label; await setDoc(configDoc,{columns},{merge:true}); renderDynamicInputs(); renderTableHead(); showToast('Column renamed','success');
    });
    columnsList.addEventListener('click', async (e)=>{
      const btn=e.target.closest('button'); if(!btn) return; const act=btn.getAttribute('data-act');
      if (act==='del'){ const id=btn.getAttribute('data-id'); if(!confirm('Delete this column? Existing data will remain in old notes but new forms won\'t include it.')) return; columns=columns.filter(c=>c.id!==id); await setDoc(configDoc,{columns},{merge:true}); renderColumnsManager(); renderDynamicInputs(); renderTableHead(); }
      if (act==='up' || act==='down'){ const i=parseInt(btn.getAttribute('data-idx')); const j=act==='up'?i-1:i+1; if (j<0||j>=columns.length) return; const tmp=columns[i]; columns[i]=columns[j]; columns[j]=tmp; await setDoc(configDoc,{columns},{merge:true}); renderColumnsManager(); renderDynamicInputs(); renderTableHead(); }
    });
    addColBtn.addEventListener('click', async ()=>{
      const label=(newColLabel.value||'').trim(); if(!label) return; const id=label.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); if(columns.some(c=>c.id===id)){ showToast('Column id already exists','error'); return; }
      columns.push({id,label}); await setDoc(configDoc,{columns},{merge:true}); newColLabel.value=''; renderColumnsManager(); renderDynamicInputs(); renderTableHead(); showToast('Column added','success');
    });

    // Build dynamic inputs from columns
    function renderDynamicInputs(){ inputs.dynamicFields.innerHTML=''; columns.forEach(c=>{ const wrap=document.createElement('div'); wrap.innerHTML=`<label class='block text-sm font-semibold mb-1'>${c.label}</label><input data-col='${c.id}' type='text' class='w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3' />`; inputs.dynamicFields.appendChild(wrap); }); }

    // Table head based on columns
    function renderTableHead(){ tableHead.innerHTML = `<tr>
        <th class='px-6 py-3 font-semibold'>📅 Date</th>
        <th class='px-6 py-3 font-semibold'>👤 Student</th>
        ${columns.map(c=>`<th class='px-6 py-3 font-semibold'>${c.label}</th>`).join('')}
        <th class='px-6 py-3 font-semibold'>⚡ Actions</th>
      </tr>`; }

    // Helpers
    const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); const noteId=(date,student)=>`${date}_${slug(student)}`;
    function showToast(text,type='success'){ toast.textContent=text; toast.className=`notification show ${type}`; setTimeout(()=>toast.classList.remove('show'),1500); }

    // Edit mode
    let editingKey=null; const formTitle=document.getElementById('formTitle'); const saveText=document.getElementById('saveText'); const saveSpinner=document.getElementById('saveSpinner'); const saveStatus=document.getElementById('saveStatus'); const cancelEditBtn=document.getElementById('cancelEditBtn');
    function setEditMode(n=null){ if(n){ editingKey=n.id; formTitle.textContent='✏️ Edit Entry'; saveText.textContent='✅ Update Entry'; cancelEditBtn.classList.remove('hidden'); inputs.student.value=n.student; // fill dynamic
        Array.from(inputs.dynamicFields.querySelectorAll('input[data-col]')).forEach(inp=>{ const key=inp.getAttribute('data-col'); inp.value = (n.fields?.[key] ?? n[key] ?? '') });
      } else { editingKey=null; formTitle.textContent='✨ New Entry'; saveText.textContent='💾 Save Entry'; cancelEditBtn.classList.add('hidden'); document.getElementById('notesForm').reset(); renderDynamicInputs(); }
    }
    cancelEditBtn.addEventListener('click',()=>setEditMode(null));

    // Save
    document.getElementById('notesForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const student=inputs.student.value; if(!student) { saveStatus.textContent='Choose a student'; return; }
      const id=editingKey||noteId(today,student); const ref=doc(notesCol,id);
      const fields={}; Array.from(inputs.dynamicFields.querySelectorAll('input[data-col]')).forEach(inp=>{ fields[inp.getAttribute('data-col')] = inp.value.trim(); });
      const payload={ id, date:today, student, fields, updatedAt:serverTimestamp(), ownerUid:auth.currentUser?.uid||null };
      const snap=await getDoc(ref); if(!snap.exists()) payload.createdAt=serverTimestamp();
      await setDoc(ref,payload,{merge:true}); showToast(editingKey?'Updated ✓':'Saved ✓','success'); saveStatus.textContent=editingKey?'Updated ✅':'Saved ✅'; setTimeout(()=>saveStatus.textContent='',1200); setEditMode(null);
    });

    // History stream & filters
    let unsub=null, allRows=[];
    function startHistoryStream(){ if(unsub)unsub(); const q=query(notesCol,orderBy('date','desc'),qLimit(200)); unsub=onSnapshot(q,(snap)=>{ allRows=snap.docs.map(d=>d.data()); applyFilters(); }); }
    function applyFilters(){ const s=filterStudent.value; const d=filterDate.value; let list=allRows; if(s) list=list.filter(r=>r.student===s); if(d) list=list.filter(r=>r.date===d); renderHistory(list); }
    filterStudent.addEventListener('change',applyFilters); filterDate.addEventListener('change',applyFilters); document.getElementById('clearFilters').addEventListener('click',()=>{filterStudent.value=''; filterDate.value=''; applyFilters();}); document.getElementById('reload').addEventListener('click',applyFilters);

    function esc(s){return (s??'').replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]))}
    function renderHistory(rows){ historyBody.innerHTML=''; if(!rows.length){ emptyState.classList.remove('hidden'); countInfo.textContent='0 notes'; return;} emptyState.classList.add('hidden');
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`
        <td class='px-6 py-3 font-medium'>${r.date}</td>
        <td class='px-6 py-3'>${r.student}</td>
        ${columns.map(c=>`<td class='px-6 py-3'>${esc(r.fields?.[c.id] ?? r[c.id] ?? '')}</td>`).join('')}
        <td class='px-6 py-3 whitespace-nowrap'>
          <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-slate-300 mr-2 hover:bg-slate-100 dark:hover:bg-slate-800' data-action='edit' data-id='${r.id}'>Edit</button>
          <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-red-300 text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20' data-action='delete' data-id='${r.id}'>Delete</button>
        </td>`; historyBody.appendChild(tr); }); countInfo.textContent=`${rows.length} note${rows.length===1?'':'s'} shown`; }

    historyBody.addEventListener('click', async (e)=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); if(btn.getAttribute('data-action')==='edit'){ const snap=await getDoc(doc(notesCol,id)); if (snap.exists()) setEditMode(snap.data()); } else if(btn.getAttribute('data-action')==='delete'){ if(!confirm('Delete this note?')) return; await deleteDoc(doc(notesCol,id)); showToast('Deleted','success'); }});

    // Auth gate & bootstrap
    onAuthStateChanged(auth,(user)=>{ if(user){ authGate.classList.add('hidden'); appShell.classList.remove('hidden'); whoami.textContent=user.email||user.uid; authStatus.textContent='Online'; bootstrap(); } else { appShell.classList.add('hidden'); authGate.classList.remove('hidden'); whoami.textContent='Not signed in'; authStatus.textContent='Signed out'; }});

    async function bootstrap(){ await ensureDefaultColumns(); startHistoryStream(); }
  </script>
</body>
</html>
