<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari ‚Äî Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      color-scheme: light dark;
      --grad-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --grad-2: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --grad-emerald: linear-gradient(135deg,#10b981 0%,#059669 100%);
      --glow: 0 0 30px rgba(102,126,234,.35);
      --glow-emerald: 0 0 30px rgba(16,185,129,.35);
    }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;scroll-behavior:smooth}
    .glass{backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .gradient-animated{background:linear-gradient(-45deg,#667eea,#764ba2,#4facfe,#00f2fe);background-size:400% 400%;animation:gradShift 10s ease infinite}
    @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
    .btn-primary{background:var(--grad-emerald);position:relative;overflow:hidden;transition:transform .2s ease, box-shadow .2s ease}
    .btn-primary::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);transition:left .5s}
    .btn-primary:hover::before{left:100%}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:var(--glow-emerald)}
    .spinner{width:18px;height:18px;border:2px solid rgba(16,185,129,.35);border-top:2px solid #10b981;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:4px}
    .notification{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:600;z-index:50;transform:translateX(320px);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:linear-gradient(135deg,#10b981,#059669)}
    .notification.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen overflow-x-hidden">
  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-8 relative">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="float">
        <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-emerald-600">Attari Class Tracker</h1>
        <div class="w-24 h-1 gradient-animated mx-auto mt-4 rounded-full"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">Beautiful, responsive progress tracking for your class.</p>
        <p class="mt-2 text-sm"><span id="authStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 dark:bg-slate-800/70 ring-1 ring-slate-200 dark:ring-slate-700"><span class="w-2 h-2 rounded-full bg-amber-400" id="dot"></span> <span id="whoami">Not signed in</span> ‚Ä¢ <span id="todayDisplay"></span></span></p>
      </div>
    </header>

    <!-- AUTH GATE (styled) -->
    <div id="authGate" class="max-w-xl mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-emerald-600">Sign in</h2>
          <button id="showSignup" class="text-sm text-emerald-700 hover:underline">Create account</button>
        </div>
        <form id="signinForm" class="p-6 md:p-8 space-y-4">
          <input id="siEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="siPass" type="password" placeholder="Password" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Sign in</button>
          <p id="siMsg" class="text-sm text-slate-500"></p>
        </form>
        <form id="signupForm" class="hidden p-6 md:p-8 space-y-4">
          <div class="text-sm text-slate-500">Create your teacher account.</div>
          <input id="suEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="suPass" type="password" placeholder="Password (min 6)" minlength="6" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Create account</button>
          <p id="suMsg" class="text-sm text-slate-500"></p>
          <div class="text-sm"><button id="showSignin" type="button" class="text-emerald-700 hover:underline">Back to sign in</button></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
        <!-- Form Card -->
        <section class="xl:col-span-2">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600"><span id="formTitle">‚ú® New Entry</span></h2>
              <button id="signOutBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm">Sign out</button>
            </div>
            <form id="notesForm" class="p-6 md:p-8 space-y-6">
              <div>
                <label class="block text-sm font-semibold mb-1">üë§ Student</label>
                <select id="student" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required>
                  <option value="" disabled selected>Choose a student‚Ä¶</option>
                </select>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-1">üìñ Quran</label><input id="quran" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-blue-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üïå Surah</label><input id="surah" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-purple-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">ü§≤ Laws of Salah</label><input id="laws" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-indigo-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üåô Qamar</label><input id="qamar" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-pink-500 focus:ring-0" /></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">üí≠ Additional Notes</label>
                <textarea id="anything" rows="4" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0"></textarea>
              </div>
              <div class="flex flex-col sm:flex-row gap-4">
                <button id="saveBtn" type="submit" class="btn-primary flex-1 px-6 py-4 rounded-2xl text-white font-bold inline-flex items-center justify-center gap-3"><span id="saveText">üíæ Save Entry</span><div id="saveSpinner" class="spinner hidden"></div></button>
                <button id="cancelEditBtn" type="button" class="hidden px-6 py-4 rounded-2xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 font-medium border border-slate-300/40 dark:border-slate-600/40">‚úñÔ∏è Cancel Edit</button>
              </div>
              <div id="saveStatus" class="text-center text-sm font-medium"></div>
            </form>
          </div>
        </section>

        <!-- History Card -->
        <section class="xl:col-span-3">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">üìä Progress History</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Real‚Äëtime per‚Äëstudent notes (latest first)</p>
              </div>
              <div class="flex flex-wrap gap-3">
                <select id="filterStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500">
                  <option value="">All students</option>
                </select>
                <input id="filterDate" type="date" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500" />
                <button id="clearFilters" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200">üîÑ Clear</button>
              </div>
            </div>
            <div class="overflow-hidden">
              <div class="overflow-x-auto custom-scrollbar max-h-96">
                <table class="min-w-full text-left text-sm">
                  <thead class="sticky top-0 backdrop-blur bg-slate-100/90 dark:bg-slate-800/90">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üë§ Student</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                      <th class="px-6 py-3 font-semibold">‚ö° Actions</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="emptyState" class="hidden text-center py-14">
                <div class="text-6xl mb-3">üìù</div>
                <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-400">No entries yet</h3>
                <p class="text-slate-500">Add your first note using the form.</p>
              </div>
            </div>
            <div class="p-6 flex items-center justify-between border-t border-slate-200/50 dark:border-slate-700/50">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <button id="reload" class="px-4 py-2 rounded-xl text-white font-medium shadow-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600">üîÑ Refresh</button>
            </div>
          </div>
        </section>

        <!-- Monthly Reports Card -->
        <section class="xl:col-span-5">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600">üóìÔ∏è Monthly Reports</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Review per-student progress and export it as a CSV file.</p>
              </div>
              <div class="flex flex-wrap gap-3 items-center">
                <select id="reportStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500">
                  <option value="" disabled selected>Select a student‚Ä¶</option>
                </select>
                <input id="reportMonth" type="month" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500" />
                <button id="reportDownload" type="button" class="px-4 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚¨áÔ∏è Download CSV</button>
              </div>
            </div>
            <div class="p-6 md:p-8 space-y-6">
              <div id="reportInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <div id="reportTableWrapper" class="overflow-x-auto custom-scrollbar hidden">
                <table class="min-w-full text-left text-sm">
                  <thead class="bg-slate-100/80 dark:bg-slate-800/80">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                    </tr>
                  </thead>
                  <tbody id="reportBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="reportEmpty" class="text-center text-slate-500 py-10">
                <div class="text-5xl mb-3">üìÇ</div>
                <p id="reportEmptyText">Select a student to see their monthly report.</p>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-12 text-center">
        <div class="glass bg-white/60 dark:bg-slate-800/60 rounded-2xl px-6 py-4 inline-block">
          <p class="text-xs text-slate-600 dark:text-slate-400">üîí Data: <span class="font-mono font-semibold">classes/Attari/notes</span> ‚Ä¢ Unique per <em>date + student</em></p>
        </div>
      </footer>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, query, orderBy, limit as qLimit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw", authDomain:"attari-579d2.firebaseapp.com", projectId:"attari-579d2", storageBucket:"attari-579d2.firebasestorage.app", messagingSenderId:"765966619098", appId:"1:765966619098:web:9ab852c4881426472b70e3" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authGate = document.getElementById('authGate');
    const appShell = document.getElementById('app');
    const authStatus = document.getElementById('authStatus');
    const dot = document.getElementById('dot');
    const whoami = document.getElementById('whoami');
    const signOutBtn = document.getElementById('signOutBtn');
    const toast = document.getElementById('toast');

    // Forms
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    document.getElementById('showSignup').addEventListener('click',()=>{signinForm.classList.add('hidden');signupForm.classList.remove('hidden')});
    document.getElementById('showSignin').addEventListener('click',()=>{signupForm.classList.add('hidden');signinForm.classList.remove('hidden')});

    signinForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=siEmail.value.trim();const pass=siPass.value;siMsg.textContent='';try{await signInWithEmailAndPassword(auth,email,pass);}catch(err){siMsg.textContent=err.message;showToast(err.message,'error')}});
    signupForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=suEmail.value.trim();const pass=suPass.value;suMsg.textContent='';try{await createUserWithEmailAndPassword(auth,email,pass);suMsg.textContent='Account created. Signed in.';showToast('Welcome!','success')}catch(err){suMsg.textContent=err.message;showToast(err.message,'error')}});
    signOutBtn?.addEventListener('click', ()=>signOut(auth));

    // Students and elements
    const students=["Siyaam Azar","Hussain Ali","Hamza Razzaq","Subhan Hussain","Milad Raza","Murtaza Arfan","Zeeshan Hussain","Mohammed Subhan Ramzan","Onees Usman","Mohammed Hassan Hussain","Ali Hussein"];
    const MONTH_LABELS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const inputs={student:document.getElementById('student'),quran:document.getElementById('quran'),surah:document.getElementById('surah'),laws:document.getElementById('laws'),qamar:document.getElementById('qamar'),anything:document.getElementById('anything')};
    const filterStudent=document.getElementById('filterStudent');
    const filterDate=document.getElementById('filterDate');
    const historyBody=document.getElementById('historyBody');
    const emptyState=document.getElementById('emptyState');
    const countInfo=document.getElementById('countInfo');
    const formTitle=document.getElementById('formTitle');
    const cancelEditBtn=document.getElementById('cancelEditBtn');
    const saveBtn=document.getElementById('saveBtn');
    const saveText=document.getElementById('saveText');
    const saveSpinner=document.getElementById('saveSpinner');
    const saveStatus=document.getElementById('saveStatus');
    const reportStudent=document.getElementById('reportStudent');
    const reportMonth=document.getElementById('reportMonth');
    const reportBody=document.getElementById('reportBody');
    const reportTableWrapper=document.getElementById('reportTableWrapper');
    const reportEmpty=document.getElementById('reportEmpty');
    const reportEmptyText=document.getElementById('reportEmptyText');
    const reportInfo=document.getElementById('reportInfo');
    const reportDownload=document.getElementById('reportDownload');

    // Populate selects
    function populateStudents(){inputs.student.innerHTML='<option value="" disabled selected>Choose a student‚Ä¶</option>';filterStudent.innerHTML='<option value="">All students</option>';reportStudent.innerHTML='<option value="" disabled selected>Select a student‚Ä¶</option>';students.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;inputs.student.appendChild(o);const o2=document.createElement('option');o2.value=o.value;o2.textContent=n;filterStudent.appendChild(o2);const o3=document.createElement('option');o3.value=o.value;o3.textContent=n;reportStudent.appendChild(o3);});}
    populateStudents();

    const now=new Date();
    const today=now.toISOString().slice(0,10);
    document.getElementById('todayDisplay').textContent=formatDisplayDate(now);
    if(reportMonth)reportMonth.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

    const CLASS_ID='Attari';
    const notesCol=collection(doc(db,'classes',CLASS_ID),'notes');

    const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const noteId=(date,student)=>`${date}_${slug(student)}`;

    // Edit mode
    let editingKey=null;
    function setEditMode(n=null){
      if(n){editingKey=n.id;formTitle.textContent='‚úèÔ∏è Edit Entry';saveText.textContent='‚úÖ Update Entry';cancelEditBtn.classList.remove('hidden');inputs.student.value=n.student;inputs.quran.value=n.quran||'';inputs.surah.value=n.surah||'';inputs.laws.value=n.lawsOfSalah||'';inputs.qamar.value=n.qamar||'';inputs.anything.value=n.anythingElse||n.other||'';}
      else{editingKey=null;formTitle.textContent='‚ú® New Entry';saveText.textContent='üíæ Save Entry';cancelEditBtn.classList.add('hidden');document.getElementById('notesForm').reset();}
    }
    cancelEditBtn.addEventListener('click',()=>setEditMode(null));

    // Save/Update
    document.getElementById('notesForm').addEventListener('submit',async(e)=>{e.preventDefault();const student=inputs.student.value;if(!student){saveStatus.textContent='Choose a student';return}saveSpinner.classList.remove('hidden');const id=editingKey||noteId(today,student);const ref=doc(notesCol,id);const payload={id,date:today,student,quran:inputs.quran.value.trim(),surah:inputs.surah.value.trim(),lawsOfSalah:inputs.laws.value.trim(),qamar:inputs.qamar.value.trim(),anythingElse:inputs.anything.value.trim(),updatedAt:serverTimestamp(),ownerUid:auth.currentUser?.uid||null};const snap=await getDoc(ref);if(!snap.exists())payload.createdAt=serverTimestamp();await setDoc(ref,payload,{merge:true});saveSpinner.classList.add('hidden');showToast(editingKey?'Updated ‚úì':'Saved ‚úì','success');saveStatus.textContent=editingKey?'Updated ‚úÖ':'Saved ‚úÖ';setTimeout(()=>saveStatus.textContent='',1200);setEditMode(null)});

    // History stream & filters
    let unsub=null, allRows=[], currentReportRows=[];
    function startHistoryStream(){ if(unsub)unsub(); const q=query(notesCol,orderBy('date','desc'),qLimit(200)); unsub=onSnapshot(q,(snap)=>{allRows=snap.docs.map(d=>d.data()); applyFilters(); renderMonthlyReport();}); }
    function applyFilters(){const s=filterStudent.value;const d=filterDate.value;let list=allRows;if(s)list=list.filter(r=>r.student===s);if(d)list=list.filter(r=>r.date===d);renderHistory(list);renderMonthlyReport();}
    filterStudent.addEventListener('change',applyFilters); filterDate.addEventListener('change',applyFilters); document.getElementById('clearFilters').addEventListener('click',()=>{filterStudent.value='';filterDate.value='';applyFilters();}); document.getElementById('reload').addEventListener('click',applyFilters);
    reportStudent?.addEventListener('change',renderMonthlyReport);
    reportMonth?.addEventListener('change',renderMonthlyReport);
    reportDownload?.addEventListener('click',()=>{if(reportDownload.disabled)return;downloadMonthlyReport();});
    renderMonthlyReport();

    function renderHistory(rows){historyBody.innerHTML=''; if(!rows.length){emptyState.classList.remove('hidden');countInfo.textContent='0 notes';return;} emptyState.classList.add('hidden'); rows.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`
          <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
          <td class='px-6 py-3'>${esc(r.student||'')}</td>
          <td class='px-6 py-3'>${esc(r.quran||'')}</td>
          <td class='px-6 py-3'>${esc(r.surah||'')}</td>
          <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
          <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
          <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          <td class='px-6 py-3 whitespace-nowrap'>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-slate-300 mr-2 hover:bg-slate-100 dark:hover:bg-slate-800' data-action='edit' data-id='${r.id}'>Edit</button>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-red-300 text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20' data-action='delete' data-id='${r.id}'>Delete</button>
          </td>`;historyBody.appendChild(tr);}); countInfo.textContent=`${rows.length} note${rows.length===1?'':'s'} shown`;}

    function renderMonthlyReport(){if(!reportStudent||!reportMonth)return;const student=reportStudent.value;const monthValue=reportMonth.value;currentReportRows=[];reportBody.innerHTML='';reportInfo.textContent='';reportDownload.disabled=true;reportTableWrapper.classList.add('hidden');reportEmpty.classList.remove('hidden');if(!student){reportEmptyText.textContent='Select a student to see their monthly report.';return;} if(!monthValue){reportEmptyText.textContent='Choose a month to view the report.';return;} const filtered=allRows.filter(r=>r.student===student&&isInMonth(r.date,monthValue)); if(!filtered.length){reportEmptyText.textContent=`No entries found for ${student} in ${formatMonthYear(monthValue)}.`;return;} const sorted=filtered.slice().sort((a,b)=>{const da=parseDate(a.date);const db=parseDate(b.date);if(da&&db)return da-db;return (a.date||'').localeCompare(b.date||'');}); reportBody.innerHTML=sorted.map(r=>`
          <tr>
            <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
            <td class='px-6 py-3'>${esc(r.quran||'')}</td>
            <td class='px-6 py-3'>${esc(r.surah||'')}</td>
            <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
            <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
            <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          </tr>`).join('');
      reportTableWrapper.classList.remove('hidden');
      reportEmpty.classList.add('hidden');
      reportInfo.textContent=`${sorted.length} entr${sorted.length===1?'y':'ies'} for ${student} in ${formatMonthYear(monthValue)}.`;
      reportDownload.disabled=false;
      currentReportRows=sorted;
    }

    function downloadMonthlyReport(){if(!currentReportRows.length||!reportStudent||!reportMonth)return;const student=reportStudent.value;const monthValue=reportMonth.value;const rows=[['Date','Student','Quran','Surah','Laws of Salah','Qamar','Notes']];currentReportRows.forEach(r=>{rows.push([formatDisplayDate(r.date),r.student||'',r.quran||'',r.surah||'',r.lawsOfSalah||'',r.qamar||'',r.anythingElse||'']);});const csv=rows.map(row=>row.map(toCsvValue).join(',')).join('\r\n');const safeStudent=slug(student||'student')||'student';const safeMonth=monthValue||'report';const filename=`${safeStudent}-${safeMonth}-report.csv`;const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download=filename;document.body.appendChild(link);link.click();setTimeout(()=>{URL.revokeObjectURL(url);link.remove();},0);showToast('Report downloaded ‚úì','success');}

    historyBody.addEventListener('click',async(e)=>{const btn=e.target.closest('button'); if(!btn) return; const id=btn.getAttribute('data-id'); if(btn.getAttribute('data-action')==='edit'){const snap=await getDoc(doc(notesCol,id)); if(snap.exists()) setEditMode(snap.data());} else if(btn.getAttribute('data-action')==='delete'){ if(!confirm('Delete this note?')) return; await deleteDoc(doc(notesCol,id)); showToast('Deleted','success'); }});

    // Auth gate
    onAuthStateChanged(auth,(user)=>{ if(user){authGate.classList.add('hidden'); appShell.classList.remove('hidden'); whoami.textContent=user.email||user.uid; authStatus.textContent='Online'; dot.className='w-2 h-2 rounded-full bg-emerald-400'; startHistoryStream(); } else { appShell.classList.add('hidden'); authGate.classList.remove('hidden'); whoami.textContent='Not signed in'; authStatus.textContent='Signed out'; dot.className='w-2 h-2 rounded-full bg-amber-400'; }});

    // Utils
    function parseDate(input){if(!input&&input!==0)return null;if(input instanceof Date)return isNaN(input.getTime())?null:input;if(typeof input?.toDate==='function'){const date=input.toDate();return date instanceof Date&&!isNaN(date.getTime())?date:null;}const str=String(input).trim();const iso=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(iso){const[,y,m,d]=iso;const date=new Date(Number(y),Number(m)-1,Number(d));return isNaN(date.getTime())?null:date;}const slash=str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(slash){const[,d,m,y]=slash;const date=new Date(Number(y),Number(m)-1,Number(d));return isNaN(date.getTime())?null:date;}const parsed=new Date(str);return isNaN(parsed.getTime())?null:parsed;}
    function formatDisplayDate(value){const date=value instanceof Date?value:parseDate(value);if(!date)return value??'';const day=String(date.getDate()).padStart(2,'0');const month=MONTH_LABELS[date.getMonth()]||'';const year=date.getFullYear();return month?`${day} ${month} ${year}`:value??'';}
    function formatMonthYear(monthValue){if(!monthValue)return '';const parts=String(monthValue).split('-');if(parts.length<2)return monthValue;const year=Number(parts[0]);const monthIndex=Number(parts[1])-1;if(Number.isNaN(year)||Number.isNaN(monthIndex)||monthIndex<0||monthIndex>11)return monthValue;const month=MONTH_LABELS[monthIndex]||'';return month?`${month} ${year}`:monthValue;}
    function isInMonth(dateValue,monthValue){const date=parseDate(dateValue);if(!date||!monthValue)return false;const [yearStr,monthStr]=String(monthValue).split('-');const year=Number(yearStr);const month=Number(monthStr);if(Number.isNaN(year)||Number.isNaN(month))return false;return date.getFullYear()===year&&date.getMonth()+1===month;}
    function toCsvValue(value){const str=(value??'').toString().replace(/"/g,'""').replace(/\r?\n/g,' ');return `"${str}"`;}
    function esc(s){return (s??'').toString().replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]))}
    function showToast(text,type='success'){ toast.textContent=text; toast.className=`notification show ${type}`; setTimeout(()=>{toast.classList.remove('show')},1600); }
  </script>
</body>
</html>
