<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari ‚Äî Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Lucide Icons for a professional look -->
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>
  <style>
    :root{
      color-scheme: light dark;
      --brand-gradient: linear-gradient(135deg, #2dd4bf 0%, #0891b2 100%);
      --brand-glow: 0 0 30px rgba(45, 212, 191, 0.4);
    }
    html,body{
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        scroll-behavior: smooth;
    }
    .glass{
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
    }
    .gradient-animated{
        background: linear-gradient(-45deg, #667eea, #764ba2, #4facfe, #00f2fe);
        background-size: 400% 400%;
        animation: gradShift 10s ease infinite;
    }
    @keyframes gradShift{
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
    }
    .float{
        animation: float 6s ease-in-out infinite;
    }
    @keyframes float{
        0%{transform:translateY(0)}
        50%{transform:translateY(-10px)}
        100%{transform:translateY(0)}
    }
    /* --- Refined Button Styles --- */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        border-radius: 0.75rem; /* rounded-xl */
        transition: all 0.2s ease;
        padding: 0.75rem 1.25rem;
        cursor: pointer;
    }
    .btn-primary {
        background: var(--brand-gradient);
        color: white;
        position: relative;
        overflow: hidden;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--brand-glow);
    }
     .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .btn-secondary {
        background-color: transparent;
        border: 1px solid #cbd5e1; /* slate-300 */
    }
    .dark .btn-secondary { border-color: #475569; /* slate-600 */ }
    .btn-secondary:hover {
        background-color: #f1f5f9; /* slate-100 */
    }
    .dark .btn-secondary:hover { background-color: #1e293b; /* slate-800 */ }

    .spinner{
        width: 18px;
        height: 18px;
        border: 2px solid rgba(45, 212, 191, 0.3);
        border-top: 2px solid #2dd4bf;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    /* --- Custom Scrollbar --- */
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:var(--brand-gradient);border-radius:4px}
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    /* --- Notification Toast --- */
    .notification{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:600;z-index:50;transform:translateX(calc(100% + 20px));transition:transform .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);}
    .notification.show{transform:translateX(0)}
    .notification.success{background:linear-gradient(135deg,#10b981,#059669)}
    .notification.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
    #confirmDialog { transition: opacity 0.2s ease, transform 0.2s ease; }
    #confirmModal.show #confirmDialog { opacity: 1; transform: scale(1); }
  </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 min-h-screen overflow-x-hidden">
  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-8 relative">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="float">
        <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-cyan-600 via-teal-500 to-emerald-500">Attari Class Tracker</h1>
        <div class="w-24 h-1 gradient-animated mx-auto mt-4 rounded-full"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">Beautiful, responsive progress tracking for your class.</p>
        <p class="mt-2 text-sm"><span id="authStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 dark:bg-slate-800/70 ring-1 ring-slate-200 dark:ring-slate-700"><span class="w-2 h-2 rounded-full bg-amber-400" id="dot"></span> <span id="whoami">Not signed in</span> ‚Ä¢ <span id="todayDisplay"></span></span></p>
      </div>
    </header>

    <!-- AUTH GATE (styled) -->
    <div id="authGate" class="max-w-md mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-600 to-teal-600 flex items-center gap-3"><i data-lucide="log-in"></i>Sign in</h2>
          <button id="showSignup" class="text-sm text-teal-600 hover:underline">Create account</button>
        </div>
        <form id="signinForm" class="p-6 md:p-8 space-y-4">
          <input id="siEmail" type="email" placeholder="Email" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors" required />
          <input id="siPass" type="password" placeholder="Password" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors" required />
          <button class="btn btn-primary w-full text-lg">Sign in</button>
          <p id="siMsg" class="text-sm text-slate-500"></p>
        </form>
        <form id="signupForm" class="hidden p-6 md:p-8 space-y-4">
          <div class="text-sm text-slate-500">Create your teacher account.</div>
          <input id="suEmail" type="email" placeholder="Email" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors" required />
          <input id="suPass" type="password" placeholder="Password (min 6)" minlength="6" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors" required />
          <button class="btn btn-primary w-full text-lg">Create account</button>
          <p id="suMsg" class="text-sm text-slate-500"></p>
          <div class="text-sm"><button id="showSignin" type="button" class="text-teal-600 hover:underline">Back to sign in</button></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <!-- Changed to a more responsive sidebar layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Form Card (now a sticky sidebar on large screens) -->
        <aside class="lg:col-span-1 lg:sticky lg:top-8 self-start">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
              <h2 id="formTitle" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-teal-500 to-cyan-500 flex items-center gap-3"><i data-lucide="plus-circle"></i>New Entry</h2>
              <button id="signOutBtn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors" aria-label="Sign out"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
            <form id="notesForm" class="p-6 md:p-8 space-y-6">
              <div>
                <label for="student" class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Student</label>
                <select id="student" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors" required>
                  <option value="" disabled selected>Choose a student‚Ä¶</option>
                </select>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Quran</label><input id="quran" type="text" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-cyan-500 focus:ring-0 transition-colors" /></div>
                <div><label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Surah</label><input id="surah" type="text" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-purple-500 focus:ring-0 transition-colors" /></div>
                <div><label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Laws of Salah</label><input id="laws" type="text" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-indigo-500 focus:ring-0 transition-colors" /></div>
                <div><label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Qamar</label><input id="qamar" type="text" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-pink-500 focus:ring-0 transition-colors" /></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-2 text-slate-600 dark:text-slate-400">Additional Notes</label>
                <textarea id="anything" rows="4" class="w-full rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0 transition-colors"></textarea>
              </div>
              <div class="flex flex-col sm:flex-row gap-3">
                <button id="saveBtn" type="submit" class="btn btn-primary flex-1"><span id="saveText">Save Entry</span><div id="saveSpinner" class="spinner hidden"></div></button>
                <button id="cancelEditBtn" type="button" class="btn btn-secondary hidden"><i data-lucide="x"></i>Cancel Edit</button>
              </div>
              <div id="saveStatus" class="text-center text-sm font-medium"></div>
            </form>
          </div>
        </aside>

        <!-- Main Content Area -->
        <main class="lg:col-span-2 space-y-8">
          <!-- History Card -->
          <section class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50">
                <div class="flex flex-col sm:flex-row gap-4 sm:items-center sm:justify-between mb-4">
                     <div>
                        <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 flex items-center gap-3"><i data-lucide="history"></i>Progress History</h2>
                        <p class="text-sm text-slate-600 dark:text-slate-400">Real-time per-student notes (latest first)</p>
                     </div>
                     <button id="reload" class="btn btn-secondary"><i data-lucide="refresh-cw"></i>Refresh</button>
                </div>
              <div class="flex flex-wrap gap-3">
                <select id="filterStudent" class="flex-1 min-w-[150px] rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500 focus:ring-0 transition-colors">
                  <option value="">All students</option>
                </select>
                <input id="filterDate" type="date" class="flex-1 min-w-[150px] rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500 focus:ring-0 transition-colors" />
                <button id="clearFilters" class="btn btn-secondary"><i data-lucide="x-circle"></i>Clear</button>
              </div>
            </div>
            <div class="overflow-hidden">
                <!-- Wrapper for max height and scrollbar -->
              <div class="overflow-auto custom-scrollbar max-h-[40rem]">
                <table class="min-w-full text-left text-sm">
                  <thead class="sticky top-0 glass bg-slate-100/90 dark:bg-slate-800/90">
                    <tr>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">Date</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">Student</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">Notes</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="emptyState" class="hidden text-center py-14">
                <div class="text-6xl mb-3">üìù</div>
                <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-400">No entries yet</h3>
                <p class="text-slate-500">Add your first note using the form.</p>
              </div>
            </div>
            <div class="p-6 flex items-center justify-between border-t border-slate-200/50 dark:border-slate-700/50">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
            </div>
          </section>

          <!-- Monthly Reports Card -->
          <section class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600 flex items-center gap-3 mb-2"><i data-lucide="calendar-days"></i>Monthly Reports</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Review per-student progress and export it.</p>
              <div class="flex flex-wrap gap-3 items-center">
                <select id="reportStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="" disabled selected>Select a student‚Ä¶</option>
                </select>
                <input id="reportMonth" type="month" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 focus:ring-0 transition-colors" />
                <select id="reportFormat" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="csv" selected>CSV</option>
                  <option value="pdf">PDF</option>
                </select>
                <button id="reportDownload" type="button" class="btn btn-primary" disabled><i data-lucide="download"></i><span>Download CSV</span></button>
              </div>
            </div>
            <div class="p-6 md:p-8 space-y-6">
              <div id="reportInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <div id="reportTableWrapper" class="overflow-x-auto custom-scrollbar hidden rounded-lg border border-slate-200 dark:border-slate-700">
                <table class="min-w-full text-left text-sm">
                  <thead class="bg-slate-100/80 dark:bg-slate-800/80">
                    <tr>
                      <th class="px-6 py-3 font-semibold">Date</th>
                      <th class="px-6 py-3 font-semibold">Quran</th>
                      <th class="px-6 py-3 font-semibold">Surah</th>
                      <th class="px-6 py-3 font-semibold">Salah</th>
                      <th class="px-6 py-3 font-semibold">Qamar</th>
                      <th class="px-6 py-3 font-semibold">Notes</th>
                    </tr>
                  </thead>
                  <tbody id="reportBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="reportEmpty" class="text-center text-slate-500 py-10">
                <div class="text-5xl mb-3">üìÇ</div>
                <p id="reportEmptyText">Select a student and month to see their report.</p>
              </div>
            </div>
          </section>
        </main>
      </div>

      <footer class="mt-12 text-center">
        <div class="bg-transparent rounded-2xl px-6 py-4 inline-block">
          <p class="text-xs text-slate-600 dark:text-slate-400">üîí Data stored securely in your private cloud.</p>
        </div>
      </footer>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div id="confirmDialog" class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg w-full max-w-sm transform transition-all opacity-0 scale-95">
      <div class="p-6">
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
             <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
          </div>
          <h3 class="mt-4 text-lg font-semibold text-slate-900 dark:text-slate-100">Delete Entry</h3>
          <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Are you sure you want to delete this entry? This action cannot be undone.</p>
        </div>
      </div>
      <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex flex-col-reverse sm:flex-row sm:justify-end gap-3 rounded-b-2xl">
        <button id="confirmCancel" type="button" class="btn btn-secondary w-full sm:w-auto">Cancel</button>
        <button id="confirmDelete" type="button" class="btn btn-primary w-full sm:w-auto" style="background: #dc2626;">Delete</button>
      </div>
    </div>
  </div>

  <!-- Lucide Icons Script (Moved here to fix loading issue) -->
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, where, limit as qLimit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw", authDomain:"attari-579d2.firebaseapp.com", projectId:"attari-579d2", storageBucket:"attari-579d2.firebasestorage.app", messagingSenderId:"765966619098", appId:"1:765966619098:web:9ab852c4881426472b70e3" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- RENDER ICONS ---
    lucide.createIcons();
    
    // UI refs
    const authGate = document.getElementById('authGate');
    const appShell = document.getElementById('app');
    const authStatus = document.getElementById('authStatus');
    const dot = document.getElementById('dot');
    const whoami = document.getElementById('whoami');
    const signOutBtn = document.getElementById('signOutBtn');
    const toast = document.getElementById('toast');
    const confirmModal = document.getElementById('confirmModal');
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const confirmCancelBtn = document.getElementById('confirmCancel');
    let noteIdToDelete = null;


    // Forms
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    document.getElementById('showSignup').addEventListener('click',()=>{signinForm.classList.add('hidden');signupForm.classList.remove('hidden')});
    document.getElementById('showSignin').addEventListener('click',()=>{signupForm.classList.add('hidden');signinForm.classList.remove('hidden')});

    signinForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=siEmail.value.trim();const pass=siPass.value;siMsg.textContent='';try{await signInWithEmailAndPassword(auth,email,pass);}catch(err){siMsg.textContent=err.message;showToast(err.message,'error')}});
    signupForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=suEmail.value.trim();const pass=suPass.value;suMsg.textContent='';try{await createUserWithEmailAndPassword(auth,email,pass);suMsg.textContent='Account created. Signed in.';showToast('Welcome!','success')}catch(err){suMsg.textContent=err.message;showToast(err.message,'error')}});
    signOutBtn?.addEventListener('click', ()=>signOut(auth));

    // Students and elements
    const students=["Siyaam Azar","Hussain Ali","Hamza Razzaq","Subhan Hussain","Milad Raza","Murtaza Arfan","Zeeshan Hussain","Mohammed Subhan Ramzan","Onees Usman","Mohammed Hassan Hussain","Ali Hussein"];
    const MONTH_LABELS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const inputs={student:document.getElementById('student'),quran:document.getElementById('quran'),surah:document.getElementById('surah'),laws:document.getElementById('laws'),qamar:document.getElementById('qamar'),anything:document.getElementById('anything')};
    const filterStudent=document.getElementById('filterStudent');
    const filterDate=document.getElementById('filterDate');
    const historyBody=document.getElementById('historyBody');
    const emptyState=document.getElementById('emptyState');
    const countInfo=document.getElementById('countInfo');
    const formTitle=document.getElementById('formTitle');
    const cancelEditBtn=document.getElementById('cancelEditBtn');
    const saveBtn=document.getElementById('saveBtn');
    const saveText=document.getElementById('saveText');
    const saveSpinner=document.getElementById('saveSpinner');
    const saveStatus=document.getElementById('saveStatus');
    const reportStudent=document.getElementById('reportStudent');
    const reportMonth=document.getElementById('reportMonth');
    const reportFormat=document.getElementById('reportFormat');
    const reportBody=document.getElementById('reportBody');
    const reportTableWrapper=document.getElementById('reportTableWrapper');
    const reportEmpty=document.getElementById('reportEmpty');
    const reportEmptyText=document.getElementById('reportEmptyText');
    const reportInfo=document.getElementById('reportInfo');
    const reportDownload=document.getElementById('reportDownload');

    // Populate selects
    function populateStudents(){
      inputs.student.innerHTML='<option value="" disabled selected>Choose a student‚Ä¶</option>';
      filterStudent.innerHTML='<option value="">All students</option>';
      reportStudent.innerHTML='<option value="" disabled selected>Select a student‚Ä¶</option>';
      students.forEach(n=>{
        const o=document.createElement('option');o.value=n;o.textContent=n;inputs.student.appendChild(o);
        const o2=document.createElement('option');o2.value=o.value;o2.textContent=n;filterStudent.appendChild(o2);
        const o3=document.createElement('option');o3.value=o.value;o3.textContent=n;reportStudent.appendChild(o3);
      });
    }
    populateStudents();

    const now=new Date();
    const todayKey=toLocalISODate(now);
    document.getElementById('todayDisplay').textContent=formatDisplayDate(todayKey);
    if(reportMonth)reportMonth.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

    const CLASS_ID='Attari';
    const notesCol=collection(doc(db,'classes',CLASS_ID),'notes');

    const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const noteId=(date,student)=>`${date}_${slug(student)}`;

    // Edit mode
    let editingKey=null;
    function setEditMode(n=null){
      if(n){
        editingKey=n.id;
        formTitle.innerHTML = '<i data-lucide="edit"></i>Edit Entry';
        saveText.textContent='Update Entry';
        cancelEditBtn.classList.remove('hidden');
        inputs.student.value=n.student;
        inputs.quran.value=n.quran||'';
        inputs.surah.value=n.surah||'';
        inputs.laws.value=n.lawsOfSalah||'';
        inputs.qamar.value=n.qamar||'';
        inputs.anything.value=n.anythingElse||n.other||'';
      } else {
        editingKey=null;
        formTitle.innerHTML = '<i data-lucide="plus-circle"></i>New Entry';
        saveText.textContent='Save Entry';
        cancelEditBtn.classList.add('hidden');
        document.getElementById('notesForm').reset();
      }
      lucide.createIcons();
    }
    cancelEditBtn.addEventListener('click',()=>setEditMode(null));

    // Save/Update
    document.getElementById('notesForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const student=inputs.student.value;
      if(!student){saveStatus.textContent='Choose a student';return}
      saveSpinner.classList.remove('hidden');
      saveText.classList.add('hidden');
      saveBtn.disabled = true;

      const defaultDate=toLocalISODate(new Date());
      const entryDate=editingKey?extractDateFromId(editingKey)||defaultDate:defaultDate;
      const id=editingKey||noteId(entryDate,student);
      const ref=doc(notesCol,id);
      const payload={
        id,
        date:entryDate,
        student,
        quran:inputs.quran.value.trim(),
        surah:inputs.surah.value.trim(),
        lawsOfSalah:inputs.laws.value.trim(),
        qamar:inputs.qamar.value.trim(),
        anythingElse:inputs.anything.value.trim(),
        updatedAt:serverTimestamp(),
        ownerUid:auth.currentUser?.uid||null
      };
      const snap=await getDoc(ref);
      if(!snap.exists())payload.createdAt=serverTimestamp();
      await setDoc(ref,payload,{merge:true});
      
      saveSpinner.classList.add('hidden');
      saveText.classList.remove('hidden');
      saveBtn.disabled = false;

      showToast(editingKey?'Updated ‚úì':'Saved ‚úì','success');
      saveStatus.textContent=editingKey?'Updated ‚úÖ':'Saved ‚úÖ';
      setTimeout(()=>saveStatus.textContent='',1200);
      setEditMode(null);
    });

    // History stream & filters
    let unsub=null, historyRows=[], currentReportRows=[];
    let reportRequestToken=0;
    let jsPdfModulePromise=null;

    function startHistoryStream(){
      if(unsub)unsub();
      const q=query(notesCol,orderBy('date','desc'),qLimit(200));
      unsub=onSnapshot(q,(snap)=>{
        historyRows=snap.docs.map(d=>({id:d.id,...d.data()}));
        applyFilters();
        renderMonthlyReport();
      });
    }

    function applyFilters(){
      const s=filterStudent.value;
      const d=filterDate.value;
      let list=historyRows;
      if(s)list=list.filter(r=>r.student===s);
      if(d)list=list.filter(r=>r.date===d);
      renderHistory(list);
      renderMonthlyReport();
    }
    filterStudent.addEventListener('change',applyFilters);
    filterDate.addEventListener('change',applyFilters);
    document.getElementById('clearFilters').addEventListener('click',()=>{filterStudent.value='';filterDate.value='';applyFilters();});
    document.getElementById('reload').addEventListener('click',applyFilters);

    async function fetchMonthlyRows(student,range){
      const baseConstraints=[where('date','>=',range.start),where('date','<=',range.end),orderBy('date','asc')];
      const mapSnap=snap=>snap.docs.map(docSnap=>({id:docSnap.id,...docSnap.data()}));
      if(!student){
        const snap=await getDocs(query(notesCol,...baseConstraints));
        return mapSnap(snap);
      }
      try{
        const snap=await getDocs(query(notesCol,where('student','==',student),...baseConstraints));
        return mapSnap(snap);
      }catch(err){
        // fallback if composite index is missing
        if(err?.code==='failed-precondition'||/index/i.test(err?.message||'')){
          const snap=await getDocs(query(notesCol,...baseConstraints));
          return mapSnap(snap).filter(r=>r.student===student);
        }
        throw err;
      }
    }

    reportStudent?.addEventListener('change',renderMonthlyReport);
    reportMonth?.addEventListener('change',renderMonthlyReport);
    reportFormat?.addEventListener('change',updateReportDownloadLabel);
    reportDownload?.addEventListener('click',async()=>{
      if(reportDownload.disabled)return;
      await downloadMonthlyReport();
    });
    renderMonthlyReport();
    updateReportDownloadLabel();

    function renderHistory(rows){
        historyBody.innerHTML='';
        if(!rows.length){
            emptyState.classList.remove('hidden');
            countInfo.textContent='0 notes';
            return;
        }
        emptyState.classList.add('hidden');
        rows.forEach(r=>{
            const tr=document.createElement('tr');
            tr.className = 'hover:bg-slate-100/50 dark:hover:bg-slate-800/50 transition-colors';
            
            // --- Consolidated Notes Column ---
            const notes = [
                { label: 'Quran', value: r.quran },
                { label: 'Surah', value: r.surah },
                { label: 'Salah', value: r.lawsOfSalah },
                { label: 'Qamar', value: r.qamar },
                { label: 'Other', value: r.anythingElse }
            ].filter(item => item.value);

            const notesHtml = notes.length > 0
                ? `<ul class="list-disc list-inside space-y-1">${notes.map(n => `<li><span class="font-semibold">${esc(n.label)}:</span> ${esc(n.value)}</li>`).join('')}</ul>`
                : '<span class="text-slate-500">No notes</span>';

            tr.innerHTML=`
                <td class='px-6 py-4 font-medium text-slate-700 dark:text-slate-300 whitespace-nowrap'>${esc(formatDisplayDate(r.date))}</td>
                <td class='px-6 py-4 font-semibold'>${esc(r.student||'')}</td>
                <td class='px-6 py-4'>${notesHtml}</td>
                <td class='px-6 py-4 whitespace-nowrap text-right'>
                    <button class='p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors' data-action='edit' data-id='${esc(r.id)}' aria-label="Edit"><i data-lucide="file-pen-line" class="w-5 h-5 text-sky-600"></i></button>
                    <button class='p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors' data-action='delete' data-id='${esc(r.id)}' aria-label="Delete"><i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i></button>
                </td>`;
            historyBody.appendChild(tr);
        });
        countInfo.textContent=`${rows.length} note${rows.length===1?'':'s'} shown`;
        lucide.createIcons();
    }

    async function renderMonthlyReport(){
      if(!reportStudent||!reportMonth)return;
      const student=reportStudent.value;
      const monthValue=reportMonth.value;

      currentReportRows=[];
      reportBody.innerHTML='';
      reportInfo.textContent='';

      if(reportDownload){
        reportDownload.disabled=true;
        updateReportDownloadLabel();
      }
      reportTableWrapper.classList.add('hidden');
      reportEmpty.classList.remove('hidden');

      if(!student){reportEmptyText.textContent='Select a student to see their monthly report.';return;}
      if(!monthValue){reportEmptyText.textContent='Choose a month to view the report.';return;}

      const requestId=++reportRequestToken;
      reportEmptyText.textContent='Loading report‚Ä¶';

      try{
        const range=getMonthDateRange(monthValue);
        if(!range){reportEmptyText.textContent='Choose a valid month to view the report.';return;}

        const rows=await fetchMonthlyRows(student,range);
        if(requestId!==reportRequestToken)return;

        const filtered=rows.filter(r=>r.student===student&&isInMonth(r.date,monthValue));
        if(!filtered.length){
          if(requestId===reportRequestToken){reportEmptyText.textContent=`No entries found for ${student} in ${formatMonthYear(monthValue)}.`;}
          return;
        }

        const sorted=filtered.slice().sort((a,b)=>{
          const da=parseDate(a.date);const db=parseDate(b.date);
          if(da&&db)return da-db;
          return (a.date||'').localeCompare(b.date||'');
        });
        if(requestId!==reportRequestToken)return;

        reportBody.innerHTML=sorted.map(r=>`
          <tr class="hover:bg-slate-100/50 dark:hover:bg-slate-800/50 transition-colors">
            <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
            <td class='px-6 py-3'>${esc(r.quran||'')}</td>
            <td class='px-6 py-3'>${esc(r.surah||'')}</td>
            <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
            <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
            <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          </tr>`).join('');

        reportTableWrapper.classList.remove('hidden');
        reportEmpty.classList.add('hidden');
        reportInfo.textContent=`${sorted.length} entr${sorted.length===1?'y':'ies'} for ${student} in ${formatMonthYear(monthValue)}.`;
        if(reportDownload){
          reportDownload.disabled=false;
          updateReportDownloadLabel();
        }
        currentReportRows=sorted;
      }catch(err){
        if(requestId!==reportRequestToken)return;
        console.error(err);
        reportEmptyText.textContent='Unable to load monthly report.';
        showToast('Failed to load monthly report','error');
      }
    }
    
    // --- Code omitted for brevity (same as original) ---
    // The following functions are identical to your original file:
    // downloadMonthlyReport, downloadMonthlyCsv, downloadMonthlyPdf
    // updateReportDownloadLabel, formatDisplayDate, toLocalISODate, 
    // parseDate, formatMonthYear, getMonthDateRange, isInMonth, 
    // extractDateFromId, onAuthStateChanged, historyBody.addEventListener,
    // showToast, esc

    async function downloadMonthlyReport(){if(!currentReportRows.length||!reportStudent||!reportMonth||!reportDownload)return;const student=reportStudent.value;const monthValue=reportMonth.value;if(!student||!monthValue)return;const format=(reportFormat?.value||'csv').toLowerCase();reportDownload.dataset.loading='true';reportDownload.disabled=true;updateReportDownloadLabel();try{if(format==='pdf'){await downloadMonthlyPdf(student,monthValue);}else{downloadMonthlyCsv(student,monthValue);}}catch(err){console.error(err);showToast('Download failed','error');}finally{if(reportDownload.dataset.loading)delete reportDownload.dataset.loading;reportDownload.disabled=!currentReportRows.length;updateReportDownloadLabel();}}
    function downloadMonthlyCsv(student,monthValue){const rows=[['Date','Student','Quran','Surah','Laws of Salah','Qamar','Notes']];currentReportRows.forEach(r=>{rows.push([formatDisplayDate(r.date),r.student,r.quran||'',r.surah||'',r.lawsOfSalah||'',r.qamar||'',r.anythingElse||'']);});const csvContent="data:text/csv;charset=utf-8,"+rows.map(e=>e.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");const a=document.createElement('a');a.href=encodeURI(csvContent);a.target='_blank';a.download=`${slug(student)}-report-${monthValue}.csv`;a.click();}
    async function downloadMonthlyPdf(student,monthValue){if(!jsPdfModulePromise){jsPdfModulePromise=import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.es.min.js').then(m=>m.jsPDF).catch(err=>{console.error("Failed to load jsPDF",err);jsPdfModulePromise=null;throw err;});}try{const jsPDF=await jsPdfModulePromise;if(!jsPDF)return;const doc=new jsPDF();const headers=[['Date','Quran','Surah','Salah','Qamar','Notes']];const data=currentReportRows.map(r=>[formatDisplayDate(r.date),r.quran||'',r.surah||'',r.lawsOfSalah||'',r.qamar||'',r.anythingElse||'']);doc.setFontSize(18);doc.text(`Monthly Report: ${student}`,14,22);doc.setFontSize(12);doc.text(`Month: ${formatMonthYear(monthValue)}`,14,30);doc.autoTable({head:headers,body:data,startY:35,theme:'striped',styles:{fontSize:8},headStyles:{fillColor:[22,163,74]},alternateRowStyles:{fillColor:[240,240,240]},});doc.save(`${slug(student)}-report-${monthValue}.pdf`);}catch(err){console.error(err);showToast('PDF download failed','error');}}
    function updateReportDownloadLabel(){if(!reportDownload)return;const format=(reportFormat?.value||'csv').toUpperCase();const loading=reportDownload.dataset.loading==='true';let text=loading?`Generating ${format}‚Ä¶`:`Download ${format}`;reportDownload.querySelector('span').textContent=text;reportDownload.disabled=!currentReportRows.length||loading;}
    function formatDisplayDate(isoDate){if(!isoDate)return'';const parts=isoDate.split('-');if(parts.length!==3)return isoDate;const[year,month,day]=parts;return`${day} ${MONTH_LABELS[parseInt(month,10)-1]} ${year}`;}
    function toLocalISODate(date){const off=date.getTimezoneOffset();const d=new Date(date.getTime()-(off*60*1000));return d.toISOString().split('T')[0];}
    function parseDate(isoDate){if(!isoDate)return null;try{return new Date(isoDate);}catch(e){return null;}}
    function formatMonthYear(monthStr){if(!monthStr)return'';const[year,month]=monthStr.split('-');return`${MONTH_LABELS[parseInt(month,10)-1]} ${year}`;}
    function getMonthDateRange(monthValue){if(!/^\d{4}-\d{2}$/.test(monthValue))return null;const[year,month]=monthValue.split('-').map(Number);const start=new Date(year,month-1,1);const end=new Date(year,month,0);return{start:toLocalISODate(start),end:toLocalISODate(end)};}
    function isInMonth(dateStr,monthValue){return dateStr&&monthValue?dateStr.startsWith(monthValue):false;}
    function extractDateFromId(id){const match=id.match(/^(\d{4}-\d{2}-\d{2})_/);return match?match[1]:null;}
    onAuthStateChanged(auth,(user)=>{if(user){authGate.classList.add('hidden');appShell.classList.remove('hidden');whoami.textContent=user.email.split('@')[0];dot.classList.remove('bg-amber-400');dot.classList.add('bg-emerald-400');startHistoryStream();}else{authGate.classList.remove('hidden');appShell.classList.add('hidden');whoami.textContent='Not signed in';dot.classList.add('bg-amber-400');dot.classList.remove('bg-emerald-400');if(unsub){unsub();unsub=null;}}});
    
    // --- Modal Logic ---
    function showConfirmModal(id) {
        noteIdToDelete = id;
        confirmModal.classList.remove('hidden');
        setTimeout(() => { // Allow display property to apply before transition
            confirmModal.classList.add('show');
            lucide.createIcons(); 
        }, 10);
    }
    function hideConfirmModal() {
        confirmModal.classList.remove('show');
        setTimeout(() => { // Wait for transition before hiding
            confirmModal.classList.add('hidden');
            noteIdToDelete = null;
        }, 200);
    }

    confirmCancelBtn.addEventListener('click', hideConfirmModal);
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) hideConfirmModal();
    });
    confirmDeleteBtn.addEventListener('click', async () => {
        if (noteIdToDelete) {
            const ref = doc(notesCol, noteIdToDelete);
            await deleteDoc(ref);
            showToast('Deleted', 'success');
            hideConfirmModal();
        }
    });

    historyBody.addEventListener('click',async(e)=>{const target=e.target.closest('button[data-action]');if(!target)return;const{action,id}=target.dataset;if(action==='edit'){const note=historyRows.find(r=>r.id===id);if(note)setEditMode(note);}else if(action==='delete'){ showConfirmModal(id); }});
    function showToast(msg,type='success'){toast.textContent=msg;toast.className=`notification ${type} show`;setTimeout(()=>toast.classList.remove('show'),3000);}
    function esc(s){const div=document.createElement('div');div.textContent=s;return div.innerHTML;}

  </script>
</body>
</html>

