<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ghausia ‚Äî Class Track</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      color-scheme: light dark;
      --grad-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --grad-2: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --grad-emerald: linear-gradient(135deg,#10b981 0%,#059669 100%);
      --glow: 0 0 30px rgba(102,126,234,.35);
      --glow-emerald: 0 0 30px rgba(16,185,129,.35);
    }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;scroll-behavior:smooth}
    .glass{backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .gradient-animated{background:linear-gradient(-45deg,#667eea,#764ba2,#4facfe,#00f2fe);background-size:400% 400%;animation:gradShift 10s ease infinite}
    @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
    .btn-primary{background:var(--grad-emerald);position:relative;overflow:hidden;transition:transform .2s ease, box-shadow .2s ease}
    .btn-primary::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);transition:left .5s}
    .btn-primary:hover::before{left:100%}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:var(--glow-emerald)}
    .spinner{width:18px;height:18px;border:2px solid rgba(16,185,129,.35);border-top:2px solid #10b981;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:4px}
    .notification{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:600;z-index:50;transform:translateX(320px);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:linear-gradient(135deg,#10b981,#059669)}
    .notification.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen overflow-x-hidden">
  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-8 relative">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="float">
        <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-emerald-600">Ghausia Class Track</h1>
        <div class="w-24 h-1 gradient-animated mx-auto mt-4 rounded-full"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">Beautiful, responsive progress tracking for your class.</p>
        <p class="mt-2 text-sm"><span id="authStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 dark:bg-slate-800/70 ring-1 ring-slate-200 dark:ring-slate-700"><span class="w-2 h-2 rounded-full bg-amber-400" id="dot"></span> <span id="whoami">Not signed in</span> ‚Ä¢ <span id="todayDisplay"></span></span></p>
      </div>
    </header>

    <!-- AUTH GATE (styled) -->
    <div id="authGate" class="max-w-xl mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-emerald-600">Sign in</h2>
          <button id="showSignup" class="text-sm text-emerald-700 hover:underline">Create account</button>
        </div>
        <form id="signinForm" class="p-6 md:p-8 space-y-4">
          <input id="siEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="siPass" type="password" placeholder="Password" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Sign in</button>
          <p id="siMsg" class="text-sm text-slate-500"></p>
        </form>
        <form id="signupForm" class="hidden p-6 md:p-8 space-y-4">
          <div class="text-sm text-slate-500">Create your teacher account.</div>
          <input id="suEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="suPass" type="password" placeholder="Password (min 6)" minlength="6" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="suClassName" type="text" placeholder="Class Name (e.g., Ghausia Class)" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Create account & class</button>
          <p id="suMsg" class="text-sm text-slate-500"></p>
          <div class="text-sm"><button id="showSignin" type="button" class="text-emerald-700 hover:underline">Back to sign in</button></div>
        </form>
      </div>
    </div>

    <!-- CLASS SELECTION -->
    <div id="classSelection" class="hidden max-w-4xl mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-emerald-600">Your Class</h2>
        </div>
        <div class="p-6 md:p-8">
          <div id="classesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="noClasses" class="hidden text-center py-10">
            <div class="text-5xl mb-3">üè´</div>
            <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-400">No classes yet</h3>
            <p class="text-slate-500">Create your first class to get started.</p>
          </div>
        </div>
      </div>


    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
        <!-- Form Card -->
        <section class="xl:col-span-2">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600"><span id="formTitle">‚ú® New Entry</span></h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Class: <span id="currentClassName">-</span></p>
              </div>
              <div class="flex gap-2">
                <button id="manageStudentsBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm">Manage Students</button>
                <button id="settingsBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm">Settings</button>
                <button id="signOutBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm">Sign out</button>
              </div>
            </div>
            <form id="notesForm" class="p-6 md:p-8 space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-1">üë§ Student</label>
                  <select id="student" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required>
                    <option value="" disabled selected>Choose a student‚Ä¶</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">üìÖ Date</label>
                  <input id="entryDate" type="date" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-1">üìñ Quran</label><input id="quran" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-blue-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üïå Surah</label><input id="surah" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-purple-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">ü§≤ Laws of Salah</label><input id="laws" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-indigo-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üåô Qamar</label><input id="qamar" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-pink-500 focus:ring-0" /></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">üí≠ Additional Notes</label>
                <textarea id="anything" rows="4" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0"></textarea>
              </div>
              <div class="flex flex-col sm:flex-row gap-4">
                <button id="saveBtn" type="submit" class="btn-primary flex-1 px-6 py-4 rounded-2xl text-white font-bold inline-flex items-center justify-center gap-3"><span id="saveText">üíæ Save Entry</span><div id="saveSpinner" class="spinner hidden"></div></button>
                <button id="cancelEditBtn" type="button" class="hidden px-6 py-4 rounded-2xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 font-medium border border-slate-300/40 dark:border-slate-600/40">‚úñÔ∏è Cancel Edit</button>
              </div>
              <div id="saveStatus" class="text-center text-sm font-medium"></div>
            </form>
          </div>
        </section>

        <!-- History Card -->
        <section class="xl:col-span-3">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">üìä Progress History</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Real-time per-student notes (latest first)</p>
              </div>
              <div class="flex flex-wrap gap-3">
                <select id="filterStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500">
                  <option value="">All students</option>
                </select>
                <input id="filterDate" type="date" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500" />
                <button id="clearFilters" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200">üîÑ Clear</button>
              </div>
            </div>
            <div class="overflow-hidden">
              <div class="overflow-x-auto custom-scrollbar max-h-96">
                <table class="min-w-full text-left text-sm">
                  <thead class="sticky top-0 backdrop-blur bg-slate-100/90 dark:bg-slate-800/90">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üë§ Student</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                      <th class="px-6 py-3 font-semibold">‚ö° Actions</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="emptyState" class="hidden text-center py-14">
                <div class="text-6xl mb-3">üìù</div>
                <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-400">No entries yet</h3>
                <p class="text-slate-500">Add your first note using the form.</p>
              </div>
            </div>
            <div class="p-6 flex items-center justify-between border-t border-slate-200/50 dark:border-slate-700/50">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <button id="reload" class="px-4 py-2 rounded-xl text-white font-medium shadow-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600">üîÑ Refresh</button>
            </div>
          </div>
        </section>

        <!-- Monthly Reports Card -->
        <section class="xl:col-span-5">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600">üóìÔ∏è Monthly Reports</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Review per-student progress and export it as a CSV or PDF file.</p>
              </div>
              <div class="flex flex-wrap gap-3 items-center">
                <select id="reportStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus-border-emerald-500">
                  <option value="" disabled selected>Select a student‚Ä¶</option>
                </select>
                <input id="reportMonth" type="month" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500" />
                <select id="reportFormat" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500">
                  <option value="csv" selected>CSV</option>
                  <option value="pdf">PDF</option>
                </select>
                <button id="reportDownload" type="button" class="px-4 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚¨áÔ∏è Download CSV</button>
              </div>
            </div>
            <div class="p-6 md:p-8 space-y-6">
              <div id="reportInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <div id="reportTableWrapper" class="overflow-x-auto custom-scrollbar hidden">
                <table class="min-w-full text-left text-sm">
                  <thead class="bg-slate-100/80 dark:bg-slate-800/80">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                    </tr>
                  </thead>
                  <tbody id="reportBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="reportEmpty" class="text-center text-slate-500 py-10">
                <div class="text-5xl mb-3">üìÇ</div>
                <p id="reportEmptyText">Select a student to see their monthly report.</p>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-12 text-center">
        <div class="glass bg-white/60 dark:bg-slate-800/60 rounded-2xl px-6 py-4 inline-block">
          <p class="text-xs text-slate-600 dark:text-slate-400">üîí Data: <span class="font-mono font-semibold">classes/<span id="footerClassId">your-class</span>/notes</span> ‚Ä¢ Unique per <em>date + student</em></p>
        </div>
      </footer>
    </div>
  </div>

  <!-- Student Management Modal -->
  <div id="studentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="glass bg-white/90 dark:bg-slate-900/90 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
      <div class="p-6 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
        <h3 class="text-xl font-bold">Manage Students</h3>
        <button id="closeStudentModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto max-h-[60vh]">
        <!-- Add Single Student -->
        <form id="addStudentForm" class="flex gap-3 mb-4">
          <input id="newStudentName" type="text" placeholder="Student Name" class="flex-1 rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button type="submit" class="btn-primary px-6 py-3 rounded-2xl text-white font-semibold">Add Student</button>
        </form>

        <!-- Bulk Import Toggle -->
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm text-slate-600 dark:text-slate-400">Or add multiple students at once:</span>
          <button id="toggleBulkImport" class="px-3 py-1 text-xs rounded-lg ring-1 ring-slate-300 dark:ring-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Bulk Import</button>
        </div>

        <!-- Bulk Import Form -->
        <div id="bulkImportSection" class="hidden mb-6 p-4 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
          <label class="block text-sm font-semibold mb-2">Paste student names (one per line):</label>
          <textarea id="bulkStudentNames" rows="6" placeholder="Siyaam Azar&#10;Hussain Ali&#10;Hamza Razzaq&#10;..." class="w-full rounded-xl bg-white dark:bg-slate-900 border-2 border-slate-200/60 dark:border-slate-700/60 px-3 py-2 text-sm focus:border-emerald-500 focus:ring-0"></textarea>
          <div class="flex justify-end gap-2 mt-3">
            <button id="cancelBulkImport" type="button" class="px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200">Cancel</button>
            <button id="processBulkImport" type="button" class="btn-primary px-4 py-2 text-sm rounded-lg text-white font-semibold">Add All Students</button>
          </div>
        </div>
        <div id="studentsList" class="space-y-2"></div>
        <div id="noStudents" class="hidden text-center py-6 text-slate-500">
          <div class="text-3xl mb-2">üë•</div>
          <p>No students added yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="glass bg-white/90 dark:bg-slate-900/90 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
      <div class="p-6 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
        <h3 class="text-xl font-bold">Class Settings</h3>
        <button id="closeSettingsModal" class="text-slate-500 hover:text-slate-700">‚úï</button>
      </div>
      <div class="p-6 space-y-6 overflow-y-auto max-h-[60vh]">
        <div>
          <h4 class="text-lg font-semibold mb-4">Customize Form Fields</h4>
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Customize the labels and visibility of form fields:</p>
          
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableQuran" class="rounded" checked>
                <label for="enableQuran" class="font-medium">üìñ Quran Field</label>
              </div>
              <input type="text" id="quranLabel" value="üìñ Quran" class="px-3 py-1 text-sm rounded-lg bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
            </div>
            
            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableSurah" class="rounded" checked>
                <label for="enableSurah" class="font-medium">üïå Surah Field</label>
              </div>
              <input type="text" id="surahLabel" value="üïå Surah" class="px-3 py-1 text-sm rounded-lg bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
            </div>
            
            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableLaws" class="rounded" checked>
                <label for="enableLaws" class="font-medium">ü§≤ Laws of Salah Field</label>
              </div>
              <input type="text" id="lawsLabel" value="ü§≤ Laws of Salah" class="px-3 py-1 text-sm rounded-lg bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
            </div>
            
            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableQamar" class="rounded" checked>
                <label for="enableQamar" class="font-medium">üåô Qamar Field</label>
              </div>
              <input type="text" id="qamarLabel" value="üåô Qamar" class="px-3 py-1 text-sm rounded-lg bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
            </div>
            
            <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="enableNotes" class="rounded" checked>
                <label for="enableNotes" class="font-medium">üí≠ Additional Notes Field</label>
              </div>
              <input type="text" id="notesLabel" value="üí≠ Additional Notes" class="px-3 py-1 text-sm rounded-lg bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600">
            </div>
          </div>
          
          <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200/50 dark:border-slate-700/50">
            <button id="resetFieldSettings" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 font-medium">Reset to Default</button>
            <button id="saveFieldSettings" class="btn-primary px-6 py-2 rounded-xl text-white font-semibold">Save Settings</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, where, limit as qLimit, onSnapshot, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyAS37LFzGqN3YFmT5n3i3qSNXOG8G8R2as", authDomain:"attari2-f55f3.firebaseapp.com", projectId:"attari2-f55f3", storageBucket:"attari2-f55f3.firebasestorage.app", messagingSenderId:"199694820477", appId:"1:199694820477:web:163be13dba7c1878cfbd14" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authGate = document.getElementById('authGate');
    const classSelection = document.getElementById('classSelection');
    const appShell = document.getElementById('app');
    const authStatus = document.getElementById('authStatus');
    const dot = document.getElementById('dot');
    const whoami = document.getElementById('whoami');
    const signOutBtn = document.getElementById('signOutBtn');
    const toast = document.getElementById('toast');

    // Class management elements
    const classesList = document.getElementById('classesList');
    const noClasses = document.getElementById('noClasses');
    const currentClassName = document.getElementById('currentClassName');
    const manageStudentsBtn = document.getElementById('manageStudentsBtn');

    // Student management elements
    const studentModal = document.getElementById('studentModal');
    const closeStudentModal = document.getElementById('closeStudentModal');
    const addStudentForm = document.getElementById('addStudentForm');
    const newStudentName = document.getElementById('newStudentName');
    const studentsList = document.getElementById('studentsList');
    const noStudents = document.getElementById('noStudents');
    const toggleBulkImport = document.getElementById('toggleBulkImport');
    const bulkImportSection = document.getElementById('bulkImportSection');
    const bulkStudentNames = document.getElementById('bulkStudentNames');
    const cancelBulkImport = document.getElementById('cancelBulkImport');
    const processBulkImport = document.getElementById('processBulkImport');

    // Settings elements
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const saveFieldSettings = document.getElementById('saveFieldSettings');
    const resetFieldSettings = document.getElementById('resetFieldSettings');

    // Forms
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const siEmail = document.getElementById('siEmail');
    const siPass = document.getElementById('siPass');
    const siMsg = document.getElementById('siMsg');
    const suEmail = document.getElementById('suEmail');
    const suPass = document.getElementById('suPass');
    const suClassName = document.getElementById('suClassName');
    const suMsg = document.getElementById('suMsg');
    
    document.getElementById('showSignup').addEventListener('click',()=>{signinForm.classList.add('hidden');signupForm.classList.remove('hidden')});
    document.getElementById('showSignin').addEventListener('click',()=>{signupForm.classList.add('hidden');signinForm.classList.remove('hidden')});

    signinForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=siEmail.value.trim();const pass=siPass.value;siMsg.textContent='';try{await signInWithEmailAndPassword(auth,email,pass);}catch(err){siMsg.textContent=err.message;showToast(err.message,'error')}});
    signupForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=suEmail.value.trim();const pass=suPass.value;const className=suClassName.value.trim();suMsg.textContent='';try{const userCredential=await createUserWithEmailAndPassword(auth,email,pass);const user=userCredential.user;await createUserProfile(user.uid,email,className);suMsg.textContent='Account created. Signed in.';showToast('Welcome!','success')}catch(err){suMsg.textContent=err.message;showToast(err.message,'error')}});
    signOutBtn?.addEventListener('click', ()=>signOut(auth));

    // Global state
    let currentUser = null;
    let currentClassId = null;
    let currentClassData = null;
    let students = [];
    const MONTH_LABELS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const inputs={student:document.getElementById('student'),entryDate:document.getElementById('entryDate'),quran:document.getElementById('quran'),surah:document.getElementById('surah'),laws:document.getElementById('laws'),qamar:document.getElementById('qamar'),anything:document.getElementById('anything')};
    const filterStudent=document.getElementById('filterStudent');
    const filterDate=document.getElementById('filterDate');
    const historyBody=document.getElementById('historyBody');
    const emptyState=document.getElementById('emptyState');
    const countInfo=document.getElementById('countInfo');
    const formTitle=document.getElementById('formTitle');
    const cancelEditBtn=document.getElementById('cancelEditBtn');
    const saveBtn=document.getElementById('saveBtn');
    const saveText=document.getElementById('saveText');
    const saveSpinner=document.getElementById('saveSpinner');
    const saveStatus=document.getElementById('saveStatus');
    const reportStudent=document.getElementById('reportStudent');
    const reportMonth=document.getElementById('reportMonth');
    const reportFormat=document.getElementById('reportFormat');
    const reportBody=document.getElementById('reportBody');
    const reportTableWrapper=document.getElementById('reportTableWrapper');
    const reportEmpty=document.getElementById('reportEmpty');
    const reportEmptyText=document.getElementById('reportEmptyText');
    const reportInfo=document.getElementById('reportInfo');
    const reportDownload=document.getElementById('reportDownload');

    // User and Class Management
    async function createUserProfile(uid, email, className) {
      const classId = generateClassId(className);
      const userRef = doc(db, 'users', uid);
      const classRef = doc(db, 'classes', classId);
      
      await setDoc(userRef, {
        email: email,
        classes: [classId],
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      await setDoc(classRef, {
        name: className,
        owner: uid,
        students: [],
        fieldSettings: {
          quran: { enabled: true, label: 'üìñ Quran' },
          surah: { enabled: true, label: 'üïå Surah' },
          laws: { enabled: true, label: 'ü§≤ Laws of Salah' },
          qamar: { enabled: true, label: 'üåô Qamar' },
          notes: { enabled: true, label: 'üí≠ Additional Notes' }
        },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }

    async function loadUserClasses(uid) {
      const userRef = doc(db, 'users', uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return [];
      
      const userData = userSnap.data();
      const classIds = userData.classes || [];
      
      const classPromises = classIds.map(async (classId) => {
        const classRef = doc(db, 'classes', classId);
        const classSnap = await getDoc(classRef);
        if (classSnap.exists()) {
          return { id: classId, ...classSnap.data() };
        }
        return null;
      });
      
      const classes = await Promise.all(classPromises);
      return classes.filter(c => c !== null);
    }



    async function addStudentToClass(classId, studentName) {
      const classRef = doc(db, 'classes', classId);
      await setDoc(classRef, {
        students: arrayUnion(studentName),
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function removeStudentFromClass(classId, studentName) {
      const classRef = doc(db, 'classes', classId);
      await setDoc(classRef, {
        students: arrayRemove(studentName),
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    function generateClassId(className) {
      return className.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') + '-' + Date.now();
    }

    // Populate selects
    function populateStudents(){
      inputs.student.innerHTML='<option value="" disabled selected>Choose a student‚Ä¶</option>';
      filterStudent.innerHTML='<option value="">All students</option>';
      reportStudent.innerHTML='<option value="" disabled selected>Select a student‚Ä¶</option>';
      students.forEach(n=>{
        const o=document.createElement('option');o.value=n;o.textContent=n;inputs.student.appendChild(o);
        const o2=document.createElement('option');o2.value=o.value;o2.textContent=n;filterStudent.appendChild(o2);
        const o3=document.createElement('option');o3.value=o.value;o3.textContent=n;reportStudent.appendChild(o3);
      });
    }

    const now=new Date();
    const todayKey=toLocalISODate(now);
    document.getElementById('todayDisplay').textContent=formatDisplayDate(todayKey);
    if(reportMonth)reportMonth.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    if(inputs.entryDate)inputs.entryDate.value=todayKey;

    let notesCol = null;

    function updateNotesCollection() {
      if (currentClassId) {
        notesCol = collection(doc(db, 'classes', currentClassId), 'notes');
      }
    }

    const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const noteId=(date,student)=>`${date}_${slug(student)}`;

    // Edit mode
    let editingKey=null;
    function setEditMode(n=null){
      if(n){
        editingKey=n.id;
        formTitle.textContent='‚úèÔ∏è Edit Entry';
        saveText.textContent='‚úÖ Update Entry';
        cancelEditBtn.classList.remove('hidden');
        inputs.student.value=n.student;
        inputs.entryDate.value=n.date||toLocalISODate(new Date());
        inputs.quran.value=n.quran||'';
        inputs.surah.value=n.surah||'';
        inputs.laws.value=n.lawsOfSalah||'';
        inputs.qamar.value=n.qamar||'';
        inputs.anything.value=n.anythingElse||n.other||'';
        updateFormTitle();
      } else {
        editingKey=null;
        formTitle.textContent='‚ú® New Entry';
        saveText.textContent='üíæ Save Entry';
        cancelEditBtn.classList.add('hidden');
        document.getElementById('notesForm').reset();
        if(inputs.entryDate)inputs.entryDate.value=toLocalISODate(new Date());
        updateFormTitle();
      }
    }
    
    function updateFormTitle() {
      const selectedDate = inputs.entryDate?.value;
      const today = toLocalISODate(new Date());
      
      if (editingKey) {
        formTitle.textContent = '‚úèÔ∏è Edit Entry';
      } else if (selectedDate && selectedDate !== today) {
        formTitle.textContent = `‚ú® New Entry (${formatDisplayDate(selectedDate)})`;
      } else {
        formTitle.textContent = '‚ú® New Entry';
      }
    }
    
    cancelEditBtn.addEventListener('click',()=>setEditMode(null));
    
    // Update form title when date changes
    inputs.entryDate?.addEventListener('change', updateFormTitle);

    // Student Management Event Handlers

    manageStudentsBtn?.addEventListener('click', () => {
      if (currentClassId) {
        showStudentManagement();
      }
    });

    closeStudentModal?.addEventListener('click', () => {
      studentModal.classList.add('hidden');
      hideBulkImport();
    });

    addStudentForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const studentName = newStudentName.value.trim();
      if (!studentName || !currentClassId) return;
      
      try {
        await addStudentToClass(currentClassId, studentName);
        newStudentName.value = '';
        await loadCurrentClass();
        updateStudentsDisplay();
        populateStudents();
        showToast('Student added successfully!', 'success');
      } catch (error) {
        showToast('Failed to add student', 'error');
        console.error(error);
      }
    });

    // Bulk Import Event Handlers
    toggleBulkImport?.addEventListener('click', () => {
      bulkImportSection.classList.toggle('hidden');
      if (!bulkImportSection.classList.contains('hidden')) {
        bulkStudentNames.focus();
      }
    });

    cancelBulkImport?.addEventListener('click', hideBulkImport);

    processBulkImport?.addEventListener('click', async () => {
      const text = bulkStudentNames.value.trim();
      if (!text || !currentClassId) return;
      
      const names = text.split('\n')
        .map(name => name.trim())
        .filter(name => name.length > 0)
        .filter((name, index, arr) => arr.indexOf(name) === index); // Remove duplicates
      
      if (names.length === 0) {
        showToast('No valid student names found', 'error');
        return;
      }
      
      try {
        // Add students in batches to avoid overwhelming the database
        for (const name of names) {
          await addStudentToClass(currentClassId, name);
        }
        
        bulkStudentNames.value = '';
        hideBulkImport();
        await loadCurrentClass();
        updateStudentsDisplay();
        populateStudents();
        showToast(`Successfully added ${names.length} student${names.length === 1 ? '' : 's'}!`, 'success');
      } catch (error) {
        showToast('Failed to add students', 'error');
        console.error(error);
      }
    });

    function hideBulkImport() {
      bulkImportSection.classList.add('hidden');
      bulkStudentNames.value = '';
    }

    // Settings Event Handlers
    settingsBtn?.addEventListener('click', () => {
      if (currentClassId) {
        showSettings();
      }
    });

    closeSettingsModal?.addEventListener('click', () => {
      settingsModal.classList.add('hidden');
    });

    saveFieldSettings?.addEventListener('click', async () => {
      if (!currentClassId) return;
      
      try {
        const fieldSettings = {
          quran: { 
            enabled: document.getElementById('enableQuran').checked, 
            label: document.getElementById('quranLabel').value.trim() || 'üìñ Quran'
          },
          surah: { 
            enabled: document.getElementById('enableSurah').checked, 
            label: document.getElementById('surahLabel').value.trim() || 'üïå Surah'
          },
          laws: { 
            enabled: document.getElementById('enableLaws').checked, 
            label: document.getElementById('lawsLabel').value.trim() || 'ü§≤ Laws of Salah'
          },
          qamar: { 
            enabled: document.getElementById('enableQamar').checked, 
            label: document.getElementById('qamarLabel').value.trim() || 'üåô Qamar'
          },
          notes: { 
            enabled: document.getElementById('enableNotes').checked, 
            label: document.getElementById('notesLabel').value.trim() || 'üí≠ Additional Notes'
          }
        };

        const classRef = doc(db, 'classes', currentClassId);
        await setDoc(classRef, {
          fieldSettings: fieldSettings,
          updatedAt: serverTimestamp()
        }, { merge: true });

        await loadCurrentClass();
        updateFormFields();
        settingsModal.classList.add('hidden');
        showToast('Settings saved successfully!', 'success');
      } catch (error) {
        showToast('Failed to save settings', 'error');
        console.error(error);
      }
    });

    resetFieldSettings?.addEventListener('click', () => {
      document.getElementById('enableQuran').checked = true;
      document.getElementById('quranLabel').value = 'üìñ Quran';
      document.getElementById('enableSurah').checked = true;
      document.getElementById('surahLabel').value = 'üïå Surah';
      document.getElementById('enableLaws').checked = true;
      document.getElementById('lawsLabel').value = 'ü§≤ Laws of Salah';
      document.getElementById('enableQamar').checked = true;
      document.getElementById('qamarLabel').value = 'üåô Qamar';
      document.getElementById('enableNotes').checked = true;
      document.getElementById('notesLabel').value = 'üí≠ Additional Notes';
    });

    // Class and Student Display Functions
    async function loadAndDisplayClasses() {
      if (!currentUser) return;
      
      const classes = await loadUserClasses(currentUser.uid);
      
      if (classes.length === 0) {
        classesList.innerHTML = '';
        noClasses.classList.remove('hidden');
        return;
      }
      
      // Automatically select the first (and only) class
      const firstClass = classes[0];
      await selectClass(firstClass.id, firstClass.name);
    }

    async function selectClass(classId, className) {
      currentClassId = classId;
      await loadCurrentClass();
      currentClassName.textContent = className;
      updateNotesCollection();
      populateStudents();
      updateFormFields(); // Apply field settings
      showApp();
      startHistoryStream();
      
      // Update footer
      const footerClassId = document.getElementById('footerClassId');
      if (footerClassId) {
        footerClassId.textContent = classId;
      }
    }

    async function loadCurrentClass() {
      if (!currentClassId) return;
      
      const classRef = doc(db, 'classes', currentClassId);
      const classSnap = await getDoc(classRef);
      
      if (classSnap.exists()) {
        currentClassData = classSnap.data();
        students = currentClassData.students || [];
      }
    }

    function showApp() {
      classSelection.classList.add('hidden');
      appShell.classList.remove('hidden');
    }

    function showStudentManagement() {
      studentModal.classList.remove('hidden');
      updateStudentsDisplay();
    }

    function showSettings() {
      if (!currentClassData) return;
      
      const fieldSettings = currentClassData.fieldSettings || {
        quran: { enabled: true, label: 'üìñ Quran' },
        surah: { enabled: true, label: 'üïå Surah' },
        laws: { enabled: true, label: 'ü§≤ Laws of Salah' },
        qamar: { enabled: true, label: 'üåô Qamar' },
        notes: { enabled: true, label: 'üí≠ Additional Notes' }
      };

      // Populate settings form
      document.getElementById('enableQuran').checked = fieldSettings.quran?.enabled !== false;
      document.getElementById('quranLabel').value = fieldSettings.quran?.label || 'üìñ Quran';
      document.getElementById('enableSurah').checked = fieldSettings.surah?.enabled !== false;
      document.getElementById('surahLabel').value = fieldSettings.surah?.label || 'üïå Surah';
      document.getElementById('enableLaws').checked = fieldSettings.laws?.enabled !== false;
      document.getElementById('lawsLabel').value = fieldSettings.laws?.label || 'ü§≤ Laws of Salah';
      document.getElementById('enableQamar').checked = fieldSettings.qamar?.enabled !== false;
      document.getElementById('qamarLabel').value = fieldSettings.qamar?.label || 'üåô Qamar';
      document.getElementById('enableNotes').checked = fieldSettings.notes?.enabled !== false;
      document.getElementById('notesLabel').value = fieldSettings.notes?.label || 'üí≠ Additional Notes';

      settingsModal.classList.remove('hidden');
    }

    function updateFormFields() {
      if (!currentClassData) return;
      
      const fieldSettings = currentClassData.fieldSettings || {
        quran: { enabled: true, label: 'üìñ Quran' },
        surah: { enabled: true, label: 'üïå Surah' },
        laws: { enabled: true, label: 'ü§≤ Laws of Salah' },
        qamar: { enabled: true, label: 'üåô Qamar' },
        notes: { enabled: true, label: 'üí≠ Additional Notes' }
      };

      // Update form field labels and visibility
      const quranDiv = inputs.quran.closest('div');
      const surahDiv = inputs.surah.closest('div');
      const lawsDiv = inputs.laws.closest('div');
      const qamarDiv = inputs.qamar.closest('div');
      const notesDiv = inputs.anything.closest('div');

      // Update Quran field
      if (fieldSettings.quran?.enabled !== false) {
        quranDiv.style.display = '';
        quranDiv.querySelector('label').textContent = fieldSettings.quran?.label || 'üìñ Quran';
      } else {
        quranDiv.style.display = 'none';
      }

      // Update Surah field
      if (fieldSettings.surah?.enabled !== false) {
        surahDiv.style.display = '';
        surahDiv.querySelector('label').textContent = fieldSettings.surah?.label || 'üïå Surah';
      } else {
        surahDiv.style.display = 'none';
      }

      // Update Laws field
      if (fieldSettings.laws?.enabled !== false) {
        lawsDiv.style.display = '';
        lawsDiv.querySelector('label').textContent = fieldSettings.laws?.label || 'ü§≤ Laws of Salah';
      } else {
        lawsDiv.style.display = 'none';
      }

      // Update Qamar field
      if (fieldSettings.qamar?.enabled !== false) {
        qamarDiv.style.display = '';
        qamarDiv.querySelector('label').textContent = fieldSettings.qamar?.label || 'üåô Qamar';
      } else {
        qamarDiv.style.display = 'none';
      }

      // Update Notes field
      if (fieldSettings.notes?.enabled !== false) {
        notesDiv.style.display = '';
        notesDiv.querySelector('label').textContent = fieldSettings.notes?.label || 'üí≠ Additional Notes';
      } else {
        notesDiv.style.display = 'none';
      }
    }

    function updateStudentsDisplay() {
      if (!students.length) {
        studentsList.innerHTML = '';
        noStudents.classList.remove('hidden');
        return;
      }
      
      noStudents.classList.add('hidden');
      studentsList.innerHTML = students.map(student => `
        <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border border-slate-200/60 dark:border-slate-700/60">
          <span class="font-medium">${esc(student)}</span>
          <button onclick="removeStudent('${student}')" class="px-3 py-1 text-xs rounded-lg ring-1 ring-red-300 text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20">Remove</button>
        </div>
      `).join('');
    }

    window.removeStudent = async function(studentName) {
      if (!confirm(`Remove ${studentName} from the class?`)) return;
      
      try {
        await removeStudentFromClass(currentClassId, studentName);
        await loadCurrentClass();
        updateStudentsDisplay();
        populateStudents();
        showToast('Student removed successfully!', 'success');
      } catch (error) {
        showToast('Failed to remove student', 'error');
        console.error(error);
      }
    };

    window.selectClass = selectClass;

    // Save/Update
    document.getElementById('notesForm').addEventListener('submit',async(e)=>{
      e.preventDefault();
      const student=inputs.student.value;
      const selectedDate=inputs.entryDate.value;
      if(!student){saveStatus.textContent='Choose a student';return}
      if(!selectedDate){saveStatus.textContent='Choose a date';return}
      if(!currentClassId || !notesCol){saveStatus.textContent='No class selected';return}
      
      saveSpinner.classList.remove('hidden');
      const entryDate=selectedDate;
      const id=editingKey||noteId(entryDate,student);
      const ref=doc(notesCol,id);
      
      // Check if entry already exists for this date/student combination (only for new entries)
      if (!editingKey) {
        const existingSnap = await getDoc(ref);
        if (existingSnap.exists()) {
          const confirmOverwrite = confirm(`An entry already exists for ${student} on ${formatDisplayDate(entryDate)}. Do you want to update it?`);
          if (!confirmOverwrite) {
            saveSpinner.classList.add('hidden');
            return;
          }
        }
      }
      
      const payload={
        id,
        date:entryDate,
        student,
        quran:inputs.quran.value.trim(),
        surah:inputs.surah.value.trim(),
        lawsOfSalah:inputs.laws.value.trim(),
        qamar:inputs.qamar.value.trim(),
        anythingElse:inputs.anything.value.trim(),
        updatedAt:serverTimestamp(),
        ownerUid:auth.currentUser?.uid||null,
        classId:currentClassId
      };
      const snap=await getDoc(ref);
      if(!snap.exists())payload.createdAt=serverTimestamp();
      await setDoc(ref,payload,{merge:true});
      saveSpinner.classList.add('hidden');
      showToast(editingKey?'Updated ‚úì':'Saved ‚úì','success');
      saveStatus.textContent=editingKey?'Updated ‚úÖ':'Saved ‚úÖ';
      setTimeout(()=>saveStatus.textContent='',1200);
      setEditMode(null);
    });

    // History stream & filters
    let unsub=null, historyRows=[], currentReportRows=[];
    let reportRequestToken=0;
    let jsPdfModulePromise=null;

    function startHistoryStream(){
      if(unsub)unsub();
      if(!notesCol || !currentClassId) return;
      const q=query(notesCol,orderBy('date','desc'),qLimit(200));
      unsub=onSnapshot(q,(snap)=>{
        historyRows=snap.docs.map(d=>({id:d.id,...d.data()}));
        applyFilters();
        renderMonthlyReport();
      });
    }

    function applyFilters(){
      const s=filterStudent.value;
      const d=filterDate.value;
      let list=historyRows;
      if(s)list=list.filter(r=>r.student===s);
      if(d)list=list.filter(r=>r.date===d);
      renderHistory(list);
      renderMonthlyReport();
    }
    filterStudent.addEventListener('change',applyFilters);
    filterDate.addEventListener('change',applyFilters);
    document.getElementById('clearFilters').addEventListener('click',()=>{filterStudent.value='';filterDate.value='';applyFilters();});
    document.getElementById('reload').addEventListener('click',applyFilters);

    async function fetchMonthlyRows(student,range){
      if (!notesCol || !currentClassId) return [];
      const baseConstraints=[where('date','>=',range.start),where('date','<=',range.end),orderBy('date','asc')];
      const mapSnap=snap=>snap.docs.map(docSnap=>({id:docSnap.id,...docSnap.data()}));
      if(!student){
        const snap=await getDocs(query(notesCol,...baseConstraints));
        return mapSnap(snap);
      }
      try{
        const snap=await getDocs(query(notesCol,where('student','==',student),...baseConstraints));
        return mapSnap(snap);
      }catch(err){
        // fallback if composite index is missing
        if(err?.code==='failed-precondition'||/index/i.test(err?.message||'')){
          const snap=await getDocs(query(notesCol,...baseConstraints));
          return mapSnap(snap).filter(r=>r.student===student);
        }
        throw err;
      }
    }

    reportStudent?.addEventListener('change',renderMonthlyReport);
    reportMonth?.addEventListener('change',renderMonthlyReport);
    reportFormat?.addEventListener('change',updateReportDownloadLabel);
    reportDownload?.addEventListener('click',async()=>{
      if(reportDownload.disabled)return;
      await downloadMonthlyReport();
    });
    renderMonthlyReport();
    updateReportDownloadLabel();

    function renderHistory(rows){
      historyBody.innerHTML='';
      if(!rows.length){
        emptyState.classList.remove('hidden');
        countInfo.textContent='0 notes';
        return;
      }
      emptyState.classList.add('hidden');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
          <td class='px-6 py-3'>${esc(r.student||'')}</td>
          <td class='px-6 py-3'>${esc(r.quran||'')}</td>
          <td class='px-6 py-3'>${esc(r.surah||'')}</td>
          <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
          <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
          <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          <td class='px-6 py-3 whitespace-nowrap'>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-slate-300 mr-2 hover:bg-slate-100 dark:hover:bg-slate-800' data-action='edit' data-id='${r.id}'>Edit</button>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-red-300 text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20' data-action='delete' data-id='${r.id}'>Delete</button>
          </td>`;
        historyBody.appendChild(tr);
      });
      countInfo.textContent=`${rows.length} note${rows.length===1?'':'s'} shown`;
    }

    async function renderMonthlyReport(){
      if(!reportStudent||!reportMonth)return;
      const student=reportStudent.value;
      const monthValue=reportMonth.value;

      currentReportRows=[];
      reportBody.innerHTML='';
      reportInfo.textContent='';

      if(reportDownload){
        reportDownload.disabled=true;
        updateReportDownloadLabel();
      }
      reportTableWrapper.classList.add('hidden');
      reportEmpty.classList.remove('hidden');

      if(!student){reportEmptyText.textContent='Select a student to see their monthly report.';return;}
      if(!monthValue){reportEmptyText.textContent='Choose a month to view the report.';return;}

      const requestId=++reportRequestToken;
      reportEmptyText.textContent='Loading report‚Ä¶';

      try{
        const range=getMonthDateRange(monthValue);
        if(!range){reportEmptyText.textContent='Choose a valid month to view the report.';return;}

        const rows=await fetchMonthlyRows(student,range);
        if(requestId!==reportRequestToken)return;

        const filtered=rows.filter(r=>r.student===student&&isInMonth(r.date,monthValue));
        if(!filtered.length){
          if(requestId===reportRequestToken){reportEmptyText.textContent=`No entries found for ${student} in ${formatMonthYear(monthValue)}.`;}
          return;
        }

        const sorted=filtered.slice().sort((a,b)=>{
          const da=parseDate(a.date);const db=parseDate(b.date);
          if(da&&db)return da-db;
          return (a.date||'').localeCompare(b.date||'');
        });
        if(requestId!==reportRequestToken)return;

        reportBody.innerHTML=sorted.map(r=>`
          <tr>
            <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
            <td class='px-6 py-3'>${esc(r.quran||'')}</td>
            <td class='px-6 py-3'>${esc(r.surah||'')}</td>
            <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
            <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
            <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          </tr>`).join('');

        reportTableWrapper.classList.remove('hidden');
        reportEmpty.classList.add('hidden');
        reportInfo.textContent=`${sorted.length} entr${sorted.length===1?'y':'ies'} for ${student} in ${formatMonthYear(monthValue)}.`;
        if(reportDownload){
          reportDownload.disabled=false;
          updateReportDownloadLabel();
        }
        currentReportRows=sorted;
      }catch(err){
        if(requestId!==reportRequestToken)return;
        console.error(err);
        reportEmptyText.textContent='Unable to load monthly report.';
        showToast('Failed to load monthly report','error');
      }
    }

    async function downloadMonthlyReport(){
      if(!currentReportRows.length||!reportStudent||!reportMonth||!reportDownload)return;
      const student=reportStudent.value;
      const monthValue=reportMonth.value;
      if(!student||!monthValue)return;
      const format=(reportFormat?.value||'csv').toLowerCase();

      reportDownload.dataset.loading='true';
      reportDownload.disabled=true;
      updateReportDownloadLabel();

      try{
        if(format==='pdf'){
          await downloadMonthlyPdf(student,monthValue);
        }else{
          downloadMonthlyCsv(student,monthValue);
        }
      }catch(err){
        console.error(err);
        showToast('Download failed','error');
      }finally{
        if(reportDownload.dataset.loading)delete reportDownload.dataset.loading;
        reportDownload.disabled=!currentReportRows.length;
        updateReportDownloadLabel();
      }
    }

    function downloadMonthlyCsv(student,monthValue){
      const rows=[['Date','Student','Quran','Surah','Laws of Salah','Qamar','Notes']];
      currentReportRows.forEach(r=>{
        rows.push([formatDisplayDate(r.date),r.student||'',r.quran||'',r.surah||'',r.lawsOfSalah||'',r.qamar||'',r.anythingElse||'']);
      });
      const csv=rows.map(row=>row.map(toCsvValue).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=buildReportFilename(student,monthValue,'csv');
      document.body.appendChild(link);
      link.click();
      setTimeout(()=>{URL.revokeObjectURL(url);link.remove();},0);
      showToast('CSV report downloaded ‚úì','success');
    }

    async function downloadMonthlyPdf(student,monthValue){
      const module=await ensureJsPdf();
      const jsPdfConstructor=module?.jsPDF||module?.default?.jsPDF||module?.default;
      if(typeof jsPdfConstructor!=='function')throw new Error('PDF library failed to load');

      const doc=new jsPdfConstructor({orientation:'portrait',unit:'pt'});
      const margin=40;
      const pageHeight=doc.internal.pageSize.getHeight();
      const maxWidth=doc.internal.pageSize.getWidth()-margin*2;

      const monthLabel=formatMonthYear(monthValue)||monthValue;
      let y=margin;

      doc.setFont('helvetica','bold');
      doc.setFontSize(18);
      doc.text('Monthly Report',margin,y);
      y+=24;

      doc.setFont('helvetica','normal');
      doc.setFontSize(12);
      doc.text(`Student: ${student}`,margin,y); y+=16;
      doc.text(`Month: ${monthLabel}`,margin,y); y+=24;

      const lineHeight=14;
      currentReportRows.forEach((row,index)=>{
        if(y>pageHeight-margin){doc.addPage();y=margin;}
        doc.setFont('helvetica','bold');
        doc.text(`${index+1}. ${formatDisplayDate(row.date)}`,margin,y);
        y+=lineHeight;

        doc.setFont('helvetica','normal');
        const sections=[
          ['Quran',row.quran],
          ['Surah',row.surah],
          ['Laws of Salah',row.lawsOfSalah],
          ['Qamar',row.qamar],
          ['Notes',row.anythingElse],
        ];
        sections.forEach(([label,value])=>{
          const text=`‚Ä¢ ${label}: ${value||'-'}`;
          const lines=doc.splitTextToSize(text,Math.max(maxWidth-20,0));
          lines.forEach(line=>{
            if(y>pageHeight-margin){doc.addPage();y=margin;}
            doc.text(line,margin+20,y);
            y+=lineHeight;
          });
        });
        y+=lineHeight/2;
      });

      doc.save(buildReportFilename(student,monthValue,'pdf'));
      showToast('PDF report downloaded ‚úì','success');
    }

    function updateReportDownloadLabel(){
      if(!reportDownload)return;
      if(reportDownload.dataset.loading){reportDownload.textContent='Preparing‚Ä¶';return;}
      const format=(reportFormat?.value||'csv').toUpperCase();
      reportDownload.textContent=`‚¨áÔ∏è Download ${format}`;
    }

    function buildReportFilename(student,monthValue,extension){
      const safeStudent=slug(student||'student')||'student';
      const safeMonth=monthValue||'report';
      return `${safeStudent}-${safeMonth}-report.${extension}`;
    }

    function ensureJsPdf(){
      if(window.jspdf?.jsPDF)return Promise.resolve(window.jspdf);
      if(!jsPdfModulePromise){
        jsPdfModulePromise=new Promise((resolve,reject)=>{
          let script=null;
          const cleanup=()=>{script?.removeEventListener('error',onError);script?.removeEventListener('load',onLoad);};
          const onLoad=()=>{
            cleanup();
            if(window.jspdf?.jsPDF){
              resolve(window.jspdf);
            }else{
              script?.remove();
              jsPdfModulePromise=null;
              reject(new Error('PDF library failed to load'));
            }
          };
          const onError=()=>{
            cleanup();
            script?.remove();
            jsPdfModulePromise=null;
            reject(new Error('Failed to load PDF library'));
          };
          const existing=document.querySelector('script[data-jspdf-loader]');
          if(existing){
            script=existing;
            existing.addEventListener('load',onLoad,{once:true});
            existing.addEventListener('error',onError,{once:true});
            return;
          }
          script=document.createElement('script');
          script.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
          script.async=true;
          script.crossOrigin='anonymous';
          script.dataset.jspdfLoader='true';
          script.addEventListener('load',onLoad,{once:true});
          script.addEventListener('error',onError,{once:true});
          document.head.appendChild(script);
        });
        jsPdfModulePromise=jsPdfModulePromise.catch(err=>{jsPdfModulePromise=null;throw err;});
      }
      return jsPdfModulePromise;
    }

    historyBody.addEventListener('click',async(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const id=btn.getAttribute('data-id');
      if(!currentClassId || !notesCol) return;
      
      if(btn.getAttribute('data-action')==='edit'){
        const noteRef = doc(notesCol, id);
        const snap=await getDoc(noteRef);
        if(snap.exists()) setEditMode(snap.data());
      } else if(btn.getAttribute('data-action')==='delete'){
        if(!confirm('Delete this note?')) return;
        const noteRef = doc(notesCol, id);
        await deleteDoc(noteRef);
        showToast('Deleted','success');
      }
    });

    // Auth gate
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        authGate.classList.add('hidden');
        whoami.textContent = user.email || user.uid;
        authStatus.textContent = 'Online';
        dot.className = 'w-2 h-2 rounded-full bg-emerald-400';
        
        // Load user's class and go directly to app
        await loadAndDisplayClasses();
      } else {
        currentUser = null;
        currentClassId = null;
        currentClassData = null;
        students = [];
        
        appShell.classList.add('hidden');
        classSelection.classList.add('hidden');
        authGate.classList.remove('hidden');
        whoami.textContent = 'Not signed in';
        authStatus.textContent = 'Signed out';
        dot.className = 'w-2 h-2 rounded-full bg-amber-400';
        
        if (unsub) unsub();
      }
    });

    // Utils
    function extractDateFromId(id){if(!id)return null;const m=String(id).match(/^(\d{4}-\d{2}-\d{2})_/);return m?m[1]:null;}
    function parseDate(input){
      if(!input&&input!==0)return null;
      if(input instanceof Date)return isNaN(input.getTime())?null:input;
      if(typeof input?.toDate==='function'){const d=input.toDate();return d instanceof Date&&!isNaN(d.getTime())?d:null;}
      const str=String(input).trim();
      const iso=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso){const[,y,m,d]=iso;const dt=new Date(Number(y),Number(m)-1,Number(d));return isNaN(dt.getTime())?null:dt;}
      const slash=str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(slash){const[,d,m,y]=slash;const dt=new Date(Number(y),Number(m)-1,Number(d));return isNaN(dt.getTime())?null:dt;}
      const parsed=new Date(str);return isNaN(parsed.getTime())?null:parsed;
    }
    function toLocalISODate(value){
      const date=value instanceof Date?value:parseDate(value);
      if(!date)return '';
      const year=date.getFullYear();
      const month=String(date.getMonth()+1).padStart(2,'0');
      const day=String(date.getDate()).padStart(2,'0');
      return `${year}-${month}-${day}`;
    }
    function formatDisplayDate(value){
      const date=value instanceof Date?value:parseDate(value);
      if(!date)return value??'';
      const day=date.getDate();
      const month=MONTH_LABELS[date.getMonth()]||'';
      const year=date.getFullYear();
      return month?`${day} ${month} ${year}`:value??'';
    }
    function formatMonthYear(monthValue){
      if(!monthValue)return '';
      const parts=String(monthValue).split('-');
      if(parts.length<2)return monthValue;
      const year=Number(parts[0]); const monthIndex=Number(parts[1])-1;
      if(Number.isNaN(year)||Number.isNaN(monthIndex)||monthIndex<0||monthIndex>11)return monthValue;
      const month=MONTH_LABELS[monthIndex]||''; return month?`${month} ${year}`:monthValue;
    }
    function getMonthDateRange(monthValue){
      if(!monthValue)return null;
      const parts=String(monthValue).split('-'); if(parts.length<2)return null;
      const yearStr=parts[0]; const monthNum=Number(parts[1]); const monthIndex=monthNum-1; const year=Number(yearStr);
      if(Number.isNaN(year)||Number.isNaN(monthIndex)||monthIndex<0||monthIndex>11)return null;
      const monthStr=String(monthIndex+1).padStart(2,'0');
      const lastDay=new Date(year,monthIndex+1,0).getDate();
      const endDay=String(lastDay).padStart(2,'0');
      return {start:`${yearStr}-${monthStr}-01`,end:`${yearStr}-${monthStr}-${endDay}`};
    }
    function isInMonth(dateValue,monthValue){
      const date=parseDate(dateValue); if(!date||!monthValue)return false;
      const [yearStr,monthStr]=String(monthValue).split('-');
      const year=Number(yearStr); const month=Number(monthStr);
      if(Number.isNaN(year)||Number.isNaN(month))return false;
      return date.getFullYear()===year&&date.getMonth()+1===month;
    }
    function toCsvValue(value){const str=(value??'').toString().replace(/"/g,'""').replace(/\r?\n/g,' ');return `"${str}"`;}
    function esc(s){return (s??'').toString().replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]))}
    function showToast(text,type='success'){ toast.textContent=text; toast.className=`notification show ${type}`; setTimeout(()=>{toast.classList.remove('show')},1600); }
  </script>
</body>
</html>
