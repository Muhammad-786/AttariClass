<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari — Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      color-scheme: light dark;
      --grad-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --grad-2: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --grad-emerald: linear-gradient(135deg,#10b981 0%,#059669 100%);
      --grad-purple: linear-gradient(135deg,#8b5cf6 0%,#a855f7 100%);
      --grad-blue: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
      --glow: 0 0 30px rgba(102,126,234,.35);
      --glow-emerald: 0 0 30px rgba(16,185,129,.35);
      --glow-purple: 0 0 30px rgba(139,92,246,.35);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    html,body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      scroll-behavior:smooth;
      overflow-x: hidden;
    }
    
    .glass{
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .dark .glass{
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-animated{
      background:linear-gradient(-45deg,#667eea,#764ba2,#4facfe,#00f2fe,#10b981,#8b5cf6);
      background-size:600% 600%;
      animation:gradShift 15s ease infinite;
    }
    
    @keyframes gradShift{
      0%{background-position:0% 50%}
      25%{background-position:100% 0%}
      50%{background-position:100% 100%}
      75%{background-position:0% 100%}
      100%{background-position:0% 50%}
    }
    
    .float{
      animation:float 8s ease-in-out infinite;
    }
    
    @keyframes float{
      0%, 100%{transform:translateY(0px) rotate(0deg)}
      25%{transform:translateY(-8px) rotate(1deg)}
      50%{transform:translateY(-15px) rotate(0deg)}
      75%{transform:translateY(-8px) rotate(-1deg)}
    }
    
    .btn-primary{
      background:var(--grad-emerald);
      position:relative;
      overflow:hidden;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      transform:translateZ(0);
    }
    
    .btn-primary::before{
      content:"";
      position:absolute;
      inset:0;
      left:-100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);
      transition:left .6s ease;
    }
    
    .btn-primary:hover{
      transform:translateY(-3px) scale(1.02);
      box-shadow:var(--glow-emerald), var(--shadow-2xl);
    }
    
    .btn-primary:hover::before{
      left:100%;
    }
    
    .btn-primary:active{
      transform:translateY(-1px) scale(1.01);
    }
    
    .btn-secondary{
      background:var(--grad-purple);
      position:relative;
      overflow:hidden;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn-secondary:hover{
      transform:translateY(-2px);
      box-shadow:var(--glow-purple);
    }
    
    .card{
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      transform:translateZ(0);
    }
    
    .card:hover{
      transform:translateY(-5px) scale(1.02);
      box-shadow:var(--shadow-2xl);
    }
    
    .input-field{
      transition:all .3s ease;
      position:relative;
    }
    
    .input-field:focus{
      transform:scale(1.02);
      box-shadow:0 0 0 3px rgba(16,185,129,.1);
    }
    
    .spinner{
      width:18px;
      height:18px;
      border:2px solid rgba(16,185,129,.35);
      border-top:2px solid #10b981;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    .custom-scrollbar::-webkit-scrollbar{
      height:8px;
      width:8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track{
      background:rgba(148,163,184,.1);
      border-radius:4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb{
      background:linear-gradient(135deg,#667eea,#764ba2);
      border-radius:4px;
      transition:background .3s ease;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(135deg,#4f46e5,#6366f1);
    }
    
    .notification{
      position:fixed;
      top:24px;
      right:24px;
      padding:16px 20px;
      border-radius:16px;
      color:#fff;
      font-weight:600;
      z-index:50;
      transform:translateX(400px);
      transition:all .4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:var(--shadow-xl);
      backdrop-filter:blur(10px);
    }
    
    .notification.show{
      transform:translateX(0) scale(1.05);
    }
    
    .notification.success{
      background:linear-gradient(135deg,#10b981,#059669);
      box-shadow:var(--glow-emerald);
    }
    
    .notification.error{
      background:linear-gradient(135deg,#ef4444,#dc2626);
      box-shadow:0 0 30px rgba(239,68,68,.35);
    }
    
    .table-row{
      transition:all .2s ease;
    }
    
    .table-row:hover{
      background:rgba(16,185,129,.05);
      transform:scale(1.01);
    }
    
    .loading-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      backdrop-filter:blur(4px);
      z-index:40;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
    }
    
    .loading-overlay.show{
      opacity:1;
      pointer-events:all;
    }
    
    .pulse{
      animation:pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse{
      0%, 100%{opacity:1}
      50%{opacity:.5}
    }
    
    .fade-in{
      animation:fadeIn .6s ease-out forwards;
    }
    
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(20px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .slide-up{
      animation:slideUp .5s ease-out forwards;
    }
    
    @keyframes slideUp{
      from{transform:translateY(30px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      .card:hover{
        transform:none;
        box-shadow:var(--shadow-xl);
      }
      
      .notification{
        right:16px;
        left:16px;
        transform:translateY(-100px);
      }
      
      .notification.show{
        transform:translateY(0);
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen">
  
  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div class="spinner mx-auto mb-4" style="width:32px;height:32px;border-width:3px;"></div>
      <p class="text-white font-medium">Loading...</p>
    </div>
  </div>

  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  
  <div class="max-w-7xl mx-auto p-4 md:p-8 relative">
    <!-- Enhanced Header -->
    <header class="text-center mb-12 fade-in">
      <div class="float">
        <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-emerald-600 mb-6">
          Attari Class Tracker
        </h1>
        <div class="w-32 h-2 gradient-animated mx-auto mb-6 rounded-full"></div>
        <p class="text-xl text-slate-600 dark:text-slate-400 mb-4 max-w-2xl mx-auto leading-relaxed">
          Beautiful, intelligent progress tracking for Islamic education
        </p>
        <div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl glass shadow-lg">
          <span class="w-3 h-3 rounded-full bg-gradient-to-r from-emerald-400 to-green-500 pulse" id="statusDot"></span>
          <span id="whoami" class="font-medium">Connecting...</span>
          <span class="text-slate-400">•</span>
          <span id="todayDisplay" class="text-sm"></span>
        </div>
      </div>
    </header>

    <!-- Enhanced AUTH GATE -->
    <div id="authGate" class="max-w-md mx-auto slide-up">
      <div class="card glass rounded-3xl shadow-2xl border border-white/30 dark:border-slate-700/30 overflow-hidden">
        <div class="p-8 border-b border-white/20 dark:border-slate-700/30">
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </div>
            <h2 id="authTitle" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-emerald-600">Welcome Back</h2>
            <p class="text-slate-600 dark:text-slate-400 mt-2">Sign in to continue your journey</p>
          </div>
          
          <div class="flex bg-slate-100 dark:bg-slate-800 rounded-2xl p-1 mb-6">
            <button id="showSigninTab" class="flex-1 py-2 px-4 rounded-xl text-sm font-medium transition-all duration-200 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm">
              Sign In
            </button>
            <button id="showSignupTab" class="flex-1 py-2 px-4 rounded-xl text-sm font-medium transition-all duration-200 text-slate-600 dark:text-slate-400">
              Sign Up
            </button>
          </div>
        </div>
        
        <form id="signinForm" class="p-8 space-y-6">
          <div class="space-y-4">
            <div>
              <input id="siEmail" type="email" placeholder="Email address" 
                     class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 text-base focus:border-emerald-500 focus:ring-0 placeholder-slate-400" 
                     required />
            </div>
            <div>
              <input id="siPass" type="password" placeholder="Password" 
                     class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 text-base focus:border-emerald-500 focus:ring-0 placeholder-slate-400" 
                     required />
            </div>
          </div>
          
          <button id="signinBtn" type="submit" class="btn-primary w-full px-6 py-4 rounded-2xl text-white font-bold text-lg shadow-lg">
            <span id="signinText">Sign In</span>
            <div id="signinSpinner" class="spinner hidden inline-block ml-2"></div>
          </button>
          
          <p id="siMsg" class="text-sm text-center text-red-500 dark:text-red-400 min-h-[20px]"></p>
        </form>
        
        <form id="signupForm" class="hidden p-8 space-y-6">
          <div class="text-center text-slate-600 dark:text-slate-400 mb-6">
            Create your teacher account to get started
          </div>
          
          <div class="space-y-4">
            <div>
              <input id="suEmail" type="email" placeholder="Email address" 
                     class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 text-base focus:border-emerald-500 focus:ring-0 placeholder-slate-400" 
                     required />
            </div>
            <div>
              <input id="suPass" type="password" placeholder="Password (minimum 6 characters)" minlength="6"
                     class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 text-base focus:border-emerald-500 focus:ring-0 placeholder-slate-400" 
                     required />
            </div>
          </div>
          
          <button id="signupBtn" type="submit" class="btn-primary w-full px-6 py-4 rounded-2xl text-white font-bold text-lg shadow-lg">
            <span id="signupText">Create Account</span>
            <div id="signupSpinner" class="spinner hidden inline-block ml-2"></div>
          </button>
          
          <p id="suMsg" class="text-sm text-center text-red-500 dark:text-red-400 min-h-[20px]"></p>
        </form>
      </div>
    </div>

    <!-- Enhanced APP -->
    <div id="app" class="hidden fade-in">
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
        <!-- Enhanced Form Card -->
        <section class="xl:col-span-2 slide-up">
          <div class="card glass rounded-3xl shadow-2xl border border-white/30 dark:border-slate-700/30">
            <div class="p-8 border-b border-white/20 dark:border-slate-700/30 flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600">
                  <span id="formTitle">✨ New Entry</span>
                </h2>
                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Track student progress</p>
              </div>
              <button id="signOutBtn" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80 hover:bg-slate-300/80 dark:hover:bg-slate-600/80 text-sm font-medium transition-all duration-200">
                Sign out
              </button>
            </div>
            
            <form id="notesForm" class="p-8 space-y-6">
              <div>
                <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">👤 Student</label>
                <select id="student" class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-emerald-500 focus:ring-0 text-base" required>
                  <option value="" disabled selected>Choose a student…</option>
                </select>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">📖 Quran</label>
                  <input id="quran" type="text" placeholder="Current progress..." 
                         class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-blue-500 focus:ring-0 text-base placeholder-slate-400" />
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">🕌 Surah</label>
                  <input id="surah" type="text" placeholder="Surah name/progress..." 
                         class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-purple-500 focus:ring-0 text-base placeholder-slate-400" />
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">🤲 Laws of Salah</label>
                  <input id="laws" type="text" placeholder="Current topic..." 
                         class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-indigo-500 focus:ring-0 text-base placeholder-slate-400" />
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">🌙 Qamar</label>
                  <input id="qamar" type="text" placeholder="Progress notes..." 
                         class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-pink-500 focus:ring-0 text-base placeholder-slate-400" />
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold mb-3 text-slate-700 dark:text-slate-300">💭 Additional Notes</label>
                <textarea id="anything" rows="4" placeholder="Any additional observations or notes..." 
                          class="input-field w-full rounded-2xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-6 py-4 focus:border-teal-500 focus:ring-0 text-base placeholder-slate-400 resize-none"></textarea>
              </div>
              
              <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button id="saveBtn" type="submit" class="btn-primary flex-1 px-8 py-4 rounded-2xl text-white font-bold text-lg inline-flex items-center justify-center gap-3 shadow-lg">
                  <span id="saveText">💾 Save Entry</span>
                  <div id="saveSpinner" class="spinner hidden"></div>
                </button>
                <button id="cancelEditBtn" type="button" class="hidden px-8 py-4 rounded-2xl bg-slate-300/80 dark:bg-slate-700/80 hover:bg-slate-400/80 dark:hover:bg-slate-600/80 text-slate-700 dark:text-slate-200 font-bold text-lg transition-all duration-200">
                  ✖️ Cancel
                </button>
              </div>
              
              <div id="saveStatus" class="text-center text-sm font-medium min-h-[20px]"></div>
            </form>
          </div>
        </section>

        <!-- Enhanced History Card -->
        <section class="xl:col-span-3 slide-up" style="animation-delay: 0.2s;">
          <div class="card glass rounded-3xl shadow-2xl border border-white/30 dark:border-slate-700/30">
            <div class="p-8 border-b border-white/20 dark:border-slate-700/30">
              <div class="flex flex-col lg:flex-row gap-6 lg:items-center lg:justify-between">
                <div>
                  <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                    📊 Progress History
                  </h2>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Real-time student progress tracking</p>
                </div>
                
                <div class="flex flex-wrap gap-3">
                  <select id="filterStudent" class="rounded-xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500 transition-all duration-200">
                    <option value="">All students</option>
                  </select>
                  <input id="filterDate" type="date" class="rounded-xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500 transition-all duration-200" />
                  <button id="clearFilters" class="px-4 py-2 rounded-xl bg-slate-300/80 dark:bg-slate-700/80 hover:bg-slate-400/80 dark:hover:bg-slate-600/80 text-slate-700 dark:text-slate-200 font-medium transition-all duration-200">
                    🔄 Clear
                  </button>
                </div>
              </div>
            </div>
            
            <div class="overflow-hidden">
              <div class="overflow-x-auto custom-scrollbar max-h-96">
                <table class="min-w-full text-left text-sm">
                  <thead class="sticky top-0 backdrop-blur-md bg-slate-100/90 dark:bg-slate-800/90">
                    <tr>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">📅 Date</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">👤 Student</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">📖 Quran</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🕌 Surah</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🤲 Salah</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🌙 Qamar</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">💭 Notes</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">⚡ Actions</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              
              <div id="emptyState" class="hidden text-center py-16">
                <div class="text-8xl mb-6 opacity-50">📝</div>
                <h3 class="text-xl font-semibold text-slate-600 dark:text-slate-400 mb-2">No entries yet</h3>
                <p class="text-slate-500">Start tracking student progress by adding your first entry above.</p>
              </div>
            </div>
            
            <div class="p-6 flex items-center justify-between border-t border-white/20 dark:border-slate-700/30 bg-slate-50/50 dark:bg-slate-800/30">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400 font-medium"></div>
              <button id="reload" class="btn-secondary px-6 py-2 rounded-xl text-white font-medium shadow-lg">
                🔄 Refresh
              </button>
            </div>
          </div>
        </section>

        <!-- Enhanced Monthly Reports Card -->
        <section class="xl:col-span-5 slide-up" style="animation-delay: 0.4s;">
          <div class="card glass rounded-3xl shadow-2xl border border-white/30 dark:border-slate-700/30">
            <div class="p-8 border-b border-white/20 dark:border-slate-700/30">
              <div class="flex flex-col lg:flex-row gap-6 lg:items-center lg:justify-between">
                <div>
                  <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600 mb-2">
                    🗓️ Monthly Reports
                  </h2>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Generate detailed progress reports for export</p>
                </div>
                
                <div class="flex flex-wrap gap-3 items-center">
                  <select id="reportStudent" class="rounded-xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 transition-all duration-200">
                    <option value="" disabled selected>Select a student…</option>
                  </select>
                  <input id="reportMonth" type="month" class="rounded-xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 transition-all duration-200" />
                  <select id="reportFormat" class="rounded-xl bg-white/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500 transition-all duration-200">
                    <option value="csv" selected>CSV</option>
                    <option value="pdf">PDF</option>
                  </select>
                  <button id="reportDownload" type="button" class="btn-primary px-6 py-2 rounded-xl text-white font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200" disabled>
                    ⬇️ Download CSV
                  </button>
                </div>
              </div>
            </div>
            
            <div class="p-8 space-y-6">
              <div id="reportInfo" class="text-sm text-slate-600 dark:text-slate-400 font-medium"></div>
              
              <div id="reportTableWrapper" class="overflow-x-auto custom-scrollbar hidden rounded-2xl border border-slate-200/60 dark:border-slate-700/60">
                <table class="min-w-full text-left text-sm">
                  <thead class="bg-gradient-to-r from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-700">
                    <tr>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">📅 Date</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">📖 Quran</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🕌 Surah</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🤲 Salah</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">🌙 Qamar</th>
                      <th class="px-6 py-4 font-semibold text-slate-700 dark:text-slate-300">💭 Notes</th>
                    </tr>
                  </thead>
                  <tbody id="reportBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              
              <div id="reportEmpty" class="text-center text-slate-500 py-16">
                <div class="text-8xl mb-6 opacity-50">📂</div>
                <h3 class="text-xl font-semibold mb-2">Ready to Generate Reports</h3>
                <p id="reportEmptyText" class="text-slate-600 dark:text-slate-400">Select a student and month to view their progress report.</p>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Enhanced Footer -->
      <footer class="mt-16 text-center slide-up" style="animation-delay: 0.6s;">
        <div class="glass rounded-2xl px-8 py-6 inline-block shadow-lg">
          <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">
            🔒 Secure Data Storage: <span class="font-mono font-semibold text-emerald-600">classes/Attari/notes</span>
          </p>
          <p class="text-xs text-slate-500">Unique entries per date and student • Real-time synchronization</p>
        </div>
      </footer>
    </div>
  </div>

  <!-- Firebase SDKs & Enhanced JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, where, limit as qLimit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { 
      apiKey:"AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw", 
      authDomain:"attari-579d2.firebaseapp.com", 
      projectId:"attari-579d2", 
      storageBucket:"attari-579d2.firebasestorage.app", 
      messagingSenderId:"765966619098", 
      appId:"1:765966619098:web:9ab852c4881426472b70e3" 
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Enhanced UI refs
    const authGate = document.getElementById('authGate');
    const appShell = document.getElementById('app');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const statusDot = document.getElementById('statusDot');
    const whoami = document.getElementById('whoami');
    const signOutBtn = document.getElementById('signOutBtn');
    const toast = document.getElementById('toast');

    // Enhanced forms
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    const showSigninTab = document.getElementById('showSigninTab');
    const showSignupTab = document.getElementById('showSignupTab');
    const authTitle = document.getElementById('authTitle');
    const signinBtn = document.getElementById('signinBtn');
    const signupBtn = document.getElementById('signupBtn');
    const signinText = document.getElementById('signinText');
    const signupText = document.getElementById('signupText');
    const signinSpinner = document.getElementById('signinSpinner');
    const signupSpinner = document.getElementById('signupSpinner');
    const siMsg = document.getElementById('siMsg');
    const suMsg = document.getElementById('suMsg');

    // Show loading initially
    showLoading(true);

    // Enhanced tab switching
    showSigninTab?.addEventListener('click', () => {
      signupForm.classList.add('hidden');
      signinForm.classList.remove('hidden');
      showSigninTab.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'shadow-sm');
      showSigninTab.classList.remove('text-slate-600', 'dark:text-slate-400');
      showSignupTab.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'shadow-sm');
      showSignupTab.classList.add('text-slate-600', 'dark:text-slate-400');
      authTitle.textContent = 'Welcome Back';
      clearMessages();
    });

    showSignupTab?.addEventListener('click', () => {
      signinForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      showSignupTab.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'shadow-sm');
      showSignupTab.classList.remove('text-slate-600', 'dark:text-slate-400');
      showSigninTab.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-900', 'dark:text-white', 'shadow-sm');
      showSigninTab.classList.add('text-slate-600', 'dark:text-slate-400');
      authTitle.textContent = 'Create Account';
      clearMessages();
    });

    function clearMessages() {
      siMsg.textContent = '';
      suMsg.textContent = '';
    }

    function showLoading(show) {
      if (show) {
        loadingOverlay.classList.add('show');
      } else {
        loadingOverlay.classList.remove('show');
      }
    }

    function setButtonLoading(button, spinner, textEl, loading, loadingText, normalText) {
      if (loading) {
        button.disabled = true;
        spinner.classList.remove('hidden');
        textEl.textContent = loadingText;
      } else {
        button.disabled = false;
        spinner.classList.add('hidden');
        textEl.textContent = normalText;
      }
    }

    // Enhanced auth handlers
    signinForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('siEmail').value.trim();
      const pass = document.getElementById('siPass').value;
      
      clearMessages();
      setButtonLoading(signinBtn, signinSpinner, signinText, true, 'Signing in...', 'Sign In');
      
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('Welcome back! 🎉', 'success');
      } catch (err) {
        console.error('Sign in error:', err);
        siMsg.textContent = err.message;
        showToast(err.message, 'error');
      } finally {
        setButtonLoading(signinBtn, signinSpinner, signinText, false, 'Signing in...', 'Sign In');
      }
    });

    signupForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('suEmail').value.trim();
      const pass = document.getElementById('suPass').value;
      
      clearMessages();
      setButtonLoading(signupBtn, signupSpinner, signupText, true, 'Creating account...', 'Create Account');
      
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        suMsg.textContent = 'Account created successfully!';
        suMsg.className = 'text-sm text-center text-emerald-600 dark:text-emerald-400 min-h-[20px]';
        showToast('Account created! Welcome! 🎉', 'success');
      } catch (err) {
        console.error('Sign up error:', err);
        suMsg.textContent = err.message;
        suMsg.className = 'text-sm text-center text-red-500 dark:text-red-400 min-h-[20px]';
        showToast(err.message, 'error');
      } finally {
        setButtonLoading(signupBtn, signupSpinner, signupText, false, 'Creating account...', 'Create Account');
      }
    });

    signOutBtn?.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('Signed out successfully', 'success');
      } catch (err) {
        showToast('Error signing out', 'error');
      }
    });

    // Students and other existing functionality
    const students=["Siyaam Azar","Hussain Ali","Hamza Razzaq","Subhan Hussain","Milad Raza","Murtaza Arfan","Zeeshan Hussain","Mohammed Subhan Ramzan","Onees Usman","Mohammed Hassan Hussain","Ali Hussein"];
    const MONTH_LABELS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    const inputs = {
      student: document.getElementById('student'),
      quran: document.getElementById('quran'),
      surah: document.getElementById('surah'),
      laws: document.getElementById('laws'),
      qamar: document.getElementById('qamar'),
      anything: document.getElementById('anything')
    };
    
    const filterStudent = document.getElementById('filterStudent');
    const filterDate = document.getElementById('filterDate');
    const historyBody = document.getElementById('historyBody');
    const emptyState = document.getElementById('emptyState');
    const countInfo = document.getElementById('countInfo');
    const formTitle = document.getElementById('formTitle');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveBtn = document.getElementById('saveBtn');
    const saveText = document.getElementById('saveText');
    const saveSpinner = document.getElementById('saveSpinner');
    const saveStatus = document.getElementById('saveStatus');
    const reportStudent = document.getElementById('reportStudent');
    const reportMonth = document.getElementById('reportMonth');
    const reportFormat = document.getElementById('reportFormat');
    const reportBody = document.getElementById('reportBody');
    const reportTableWrapper = document.getElementById('reportTableWrapper');
    const reportEmpty = document.getElementById('reportEmpty');
    const reportEmptyText = document.getElementById('reportEmptyText');
    const reportInfo = document.getElementById('reportInfo');
    const reportDownload = document.getElementById('reportDownload');

    // Populate selects
    function populateStudents() {
      inputs.student.innerHTML = '<option value="" disabled selected>Choose a student…</option>';
      filterStudent.innerHTML = '<option value="">All students</option>';
      reportStudent.innerHTML = '<option value="" disabled selected>Select a student…</option>';
      
      students.forEach(name => {
        // Main form select
        const option1 = document.createElement('option');
        option1.value = name;
        option1.textContent = name;
        inputs.student.appendChild(option1);
        
        // Filter select
        const option2 = document.createElement('option');
        option2.value = name;
        option2.textContent = name;
        filterStudent.appendChild(option2);
        
        // Report select
        const option3 = document.createElement('option');
        option3.value = name;
        option3.textContent = name;
        reportStudent.appendChild(option3);
      });
    }
    
    populateStudents();

    const now = new Date();
    const todayKey = toLocalISODate(now);
    document.getElementById('todayDisplay').textContent = formatDisplayDate(todayKey);
    if (reportMonth) reportMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    const CLASS_ID = 'Attari';
    const notesCol = collection(doc(db, 'classes', CLASS_ID), 'notes');

    const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const noteId = (date, student) => `${date}_${slug(student)}`;

    // Edit mode
    let editingKey = null;
    function setEditMode(note = null) {
      if (note) {
        editingKey = note.id;
        formTitle.textContent = '✏️ Edit Entry';
        saveText.textContent = '✅ Update Entry';
        cancelEditBtn.classList.remove('hidden');
        inputs.student.value = note.student;
        inputs.quran.value = note.quran || '';
        inputs.surah.value = note.surah || '';
        inputs.laws.value = note.lawsOfSalah || '';
        inputs.qamar.value = note.qamar || '';
        inputs.anything.value = note.anythingElse || note.other || '';
      } else {
        editingKey = null;
        formTitle.textContent = '✨ New Entry';
        saveText.textContent = '💾 Save Entry';
        cancelEditBtn.classList.add('hidden');
        document.getElementById('notesForm').reset();
      }
    }
    
    cancelEditBtn?.addEventListener('click', () => setEditMode(null));

    // Enhanced save/update with better loading states
    document.getElementById('notesForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const student = inputs.student.value;
      if (!student) {
        saveStatus.textContent = 'Please choose a student';
        saveStatus.className = 'text-center text-sm font-medium text-red-500';
        return;
      }
      
      setButtonLoading(saveBtn, saveSpinner, saveText, true, 
        editingKey ? 'Updating...' : 'Saving...', 
        editingKey ? '✅ Update Entry' : '💾 Save Entry'
      );
      
      try {
        const defaultDate = toLocalISODate(new Date());
        const entryDate = editingKey ? extractDateFromId(editingKey) || defaultDate : defaultDate;
        const id = editingKey || noteId(entryDate, student);
        const ref = doc(notesCol, id);
        
        const payload = {
          id,
          date: entryDate,
          student,
          quran: inputs.quran.value.trim(),
          surah: inputs.surah.value.trim(),
          lawsOfSalah: inputs.laws.value.trim(),
          qamar: inputs.qamar.value.trim(),
          anythingElse: inputs.anything.value.trim(),
          updatedAt: serverTimestamp(),
          ownerUid: auth.currentUser?.uid || null
        };
        
        const snap = await getDoc(ref);
        if (!snap.exists()) payload.createdAt = serverTimestamp();
        
        await setDoc(ref, payload, { merge: true });
        
        showToast(editingKey ? 'Entry updated successfully! ✅' : 'Entry saved successfully! ✅', 'success');
        saveStatus.textContent = editingKey ? 'Updated ✅' : 'Saved ✅';
        saveStatus.className = 'text-center text-sm font-medium text-emerald-600';
        setTimeout(() => {
          saveStatus.textContent = '';
          saveStatus.className = 'text-center text-sm font-medium min-h-[20px]';
        }, 2000);
        setEditMode(null);
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save entry. Please try again.', 'error');
        saveStatus.textContent = 'Save failed ❌';
        saveStatus.className = 'text-center text-sm font-medium text-red-500';
      } finally {
        setButtonLoading(saveBtn, saveSpinner, saveText, false, 
          editingKey ? 'Updating...' : 'Saving...', 
          editingKey ? '✅ Update Entry' : '💾 Save Entry'
        );
      }
    });

    // History stream & filters
    let unsub = null, historyRows = [], currentReportRows = [];
    let reportRequestToken = 0;
    let jsPdfModulePromise = null;

    function startHistoryStream() {
      if (unsub) unsub();
      const q = query(notesCol, orderBy('date', 'desc'), qLimit(200));
      unsub = onSnapshot(q, (snap) => {
        historyRows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        applyFilters();
        renderMonthlyReport();
      }, (error) => {
        console.error('History stream error:', error);
        showToast('Failed to load history. Please refresh.', 'error');
      });
    }

    function applyFilters() {
      const studentFilter = filterStudent.value;
      const dateFilter = filterDate.value;
      let filteredList = historyRows;
      
      if (studentFilter) filteredList = filteredList.filter(r => r.student === studentFilter);
      if (dateFilter) filteredList = filteredList.filter(r => r.date === dateFilter);
      
      renderHistory(filteredList);
    }
    
    filterStudent?.addEventListener('change', applyFilters);
    filterDate?.addEventListener('change', applyFilters);
    document.getElementById('clearFilters')?.addEventListener('click', () => {
      filterStudent.value = '';
      filterDate.value = '';
      applyFilters();
    });
    document.getElementById('reload')?.addEventListener('click', applyFilters);

    async function fetchMonthlyRows(student, range) {
      const baseConstraints = [
        where('date', '>=', range.start),
        where('date', '<=', range.end),
        orderBy('date', 'asc')
      ];
      
      const mapSnap = snap => snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      
      if (!student) {
        const snap = await getDocs(query(notesCol, ...baseConstraints));
        return mapSnap(snap);
      }
      
      try {
        const snap = await getDocs(query(notesCol, where('student', '==', student), ...baseConstraints));
        return mapSnap(snap);
      } catch (err) {
        // Fallback if composite index is missing
        if (err?.code === 'failed-precondition' || /index/i.test(err?.message || '')) {
          const snap = await getDocs(query(notesCol, ...baseConstraints));
          return mapSnap(snap).filter(r => r.student === student);
        }
        throw err;
      }
    }

    reportStudent?.addEventListener('change', renderMonthlyReport);
    reportMonth?.addEventListener('change', renderMonthlyReport);
    reportFormat?.addEventListener('change', updateReportDownloadLabel);
    reportDownload?.addEventListener('click', async () => {
      if (reportDownload.disabled) return;
      await downloadMonthlyReport();
    });

    renderMonthlyReport();
    updateReportDownloadLabel();

    function renderHistory(rows) {
      historyBody.innerHTML = '';
      
      if (!rows.length) {
        emptyState.classList.remove('hidden');
        countInfo.textContent = '0 notes';
        return;
      }
      
      emptyState.classList.add('hidden');
      
      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'table-row';
        tr.innerHTML = `
          <td class='px-6 py-4 font-medium text-slate-900 dark:text-slate-100'>${esc(formatDisplayDate(row.date))}</td>
          <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(row.student || '')}</td>
          <td class='px-6 py-4 text-slate-600 dark:text-slate-400'>${esc(row.quran || '')}</td>
          <td class='px-6 py-4 text-slate-600 dark:text-slate-400'>${esc(row.surah || '')}</td>
          <td class='px-6 py-4 text-slate-600 dark:text-slate-400'>${esc(row.lawsOfSalah || '')}</td>
          <td class='px-6 py-4 text-slate-600 dark:text-slate-400'>${esc(row.qamar || '')}</td>
          <td class='px-6 py-4 text-slate-600 dark:text-slate-400'>${esc(row.anythingElse || '')}</td>
          <td class='px-6 py-4 whitespace-nowrap'>
            <button class='px-3 py-1.5 text-xs rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 mr-2 transition-all duration-200 font-medium' data-action='edit' data-id='${row.id}'>Edit</button>
            <button class='px-3 py-1.5 text-xs rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all duration-200 font-medium' data-action='delete' data-id='${row.id}'>Delete</button>
          </td>`;
        historyBody.appendChild(tr);
      });
      
      countInfo.textContent = `${rows.length} note${rows.length === 1 ? '' : 's'} shown`;
    }

    async function renderMonthlyReport() {
      if (!reportStudent || !reportMonth) return;
      
      const student = reportStudent.value;
      const monthValue = reportMonth.value;

      currentReportRows = [];
      reportBody.innerHTML = '';
      reportInfo.textContent = '';

      if (reportDownload) {
        reportDownload.disabled = true;
        updateReportDownloadLabel();
      }
      
      reportTableWrapper.classList.add('hidden');
      reportEmpty.classList.remove('hidden');

      if (!student) {
        reportEmptyText.textContent = 'Select a student to see their monthly report.';
        return;
      }
      
      if (!monthValue) {
        reportEmptyText.textContent = 'Choose a month to view the report.';
        return;
      }

      const requestId = ++reportRequestToken;
      reportEmptyText.textContent = 'Loading report…';

      try {
        const range = getMonthDateRange(monthValue);
        if (!range) {
          reportEmptyText.textContent = 'Choose a valid month to view the report.';
          return;
        }

        const rows = await fetchMonthlyRows(student, range);
        if (requestId !== reportRequestToken) return;

        const filtered = rows.filter(r => r.student === student && isInMonth(r.date, monthValue));
        if (!filtered.length) {
          if (requestId === reportRequestToken) {
            reportEmptyText.textContent = `No entries found for ${student} in ${formatMonthYear(monthValue)}.`;
          }
          return;
        }

        const sorted = filtered.slice().sort((a, b) => {
          const da = parseDate(a.date);
          const db = parseDate(b.date);
          if (da && db) return da - db;
          return (a.date || '').localeCompare(b.date || '');
        });
        
        if (requestId !== reportRequestToken) return;

        reportBody.innerHTML = sorted.map(r => `
          <tr class="table-row">
            <td class='px-6 py-4 font-medium text-slate-900 dark:text-slate-100'>${esc(formatDisplayDate(r.date))}</td>
            <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(r.quran || '')}</td>
            <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(r.surah || '')}</td>
            <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(r.lawsOfSalah || '')}</td>
            <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(r.qamar || '')}</td>
            <td class='px-6 py-4 text-slate-700 dark:text-slate-300'>${esc(r.anythingElse || '')}</td>
          </tr>`).join('');

        reportTableWrapper.classList.remove('hidden');
        reportEmpty.classList.add('hidden');
        reportInfo.textContent = `${sorted.length} entr${sorted.length === 1 ? 'y' : 'ies'} for ${student} in ${formatMonthYear(monthValue)}.`;
        
        if (reportDownload) {
          reportDownload.disabled = false;
          updateReportDownloadLabel();
        }
        
        currentReportRows = sorted;
      } catch (err) {
        if (requestId !== reportRequestToken) return;
        console.error('Monthly report error:', err);
        reportEmptyText.textContent = 'Unable to load monthly report.';
        showToast('Failed to load monthly report', 'error');
      }
    }

    async function downloadMonthlyReport() {
      if (!currentReportRows.length || !reportStudent || !reportMonth || !reportDownload) return;
      
      const student = reportStudent.value;
      const monthValue = reportMonth.value;
      if (!student || !monthValue) return;
      
      const format = (reportFormat?.value || 'csv').toLowerCase();

      reportDownload.dataset.loading = 'true';
      reportDownload.disabled = true;
      updateReportDownloadLabel();

      try {
        if (format === 'pdf') {
          await downloadMonthlyPdf(student, monthValue);
        } else {
          downloadMonthlyCsv(student, monthValue);
        }
      } catch (err) {
        console.error('Download error:', err);
        showToast('Download failed', 'error');
      } finally {
        if (reportDownload.dataset.loading) delete reportDownload.dataset.loading;
        reportDownload.disabled = !currentReportRows.length;
        updateReportDownloadLabel();
      }
    }

    function downloadMonthlyCsv(student, monthValue) {
      const rows = [['Date', 'Student', 'Quran', 'Surah', 'Laws of Salah', 'Qamar', 'Notes']];
      currentReportRows.forEach(r => {
        rows.push([
          formatDisplayDate(r.date),
          r.student || '',
          r.quran || '',
          r.surah || '',
          r.lawsOfSalah || '',
          r.qamar || '',
          r.anythingElse || ''
        ]);
      });
      
      const csv = rows.map(row => row.map(toCsvValue).join(',')).join('\r\n');
      const blob = new Blob([csv], { type
